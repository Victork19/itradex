{% extends "base.html" %}

{% block title %}iTradeX — Login{% endblock %}

{% block content %}
<div class="panel fade-slide" id="loginStep1">
  <h2 class="fw-bold mb-3 text-center">Login</h2>
  <p class="text-center text-muted mb-4">Enter your email to receive a login code.</p>
  <div class="card-radius mb-3">
    <label class="form-label">Email Address</label>
    <input type="email" id="loginEmail" class="form-control" placeholder="you@email.com">
  </div>
  <button class="btn btn-primary w-100" id="btnSendCode">Send Code</button>
</div>

<div class="panel hidden" id="loginStep2">
  <h2 class="fw-bold mb-3 text-center">Verify Your Email</h2>
  <p class="text-center text-muted mb-4">
    We’ve sent a code to <span id="verifyEmailText"></span>. Enter it below.
  </p>
  <div class="card-radius mb-3">
    <input type="text" id="verificationCode" class="form-control text-center mb-3"
           maxlength="12" placeholder="Enter your code">
    <button class="btn btn-primary w-100" id="btnVerify">Verify & Continue</button>
    <p class="small text-center text-muted mb-0">
      Didn’t get the code? <a href="#" id="btnResend" class="text-decoration-none">Resend</a>
      <span id="resendTimer" class="text-muted"></span>
    </p>
  </div>
</div>


<!-- Minimal Alert Card -->
<div id="alertCard" class="hidden card-radius bg-white shadow-sm p-3 text-center"
  style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%) scale(0.8); opacity: 0; transition: all 0.3s ease; max-width: 300px; z-index: 1000;">
  <p id="alertCardText" class="mb-0 fw-bold"></p>
</div>
{% endblock %}

{% block scripts %}
<script>
  // ===== AUTO-LOGIN CHECK ===== //
  async function checkLoginToken() {
    const token = getCookie("login_token");
    if (!token) return;
    try {
      const res = await fetch("/check_token", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      if (data.valid) {
        window.location.href = "/leaderboard";
      }
    } catch (err) {
      console.error("Token check failed", err);
    }
  }
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  document.addEventListener("DOMContentLoaded", checkLoginToken);

  // ===== ALERT HELPERS ===== //
  function showAlert(message, type = "success", duration = 2000) {
    const card = document.getElementById('alertCard');
    const text = document.getElementById('alertCardText');
    text.innerText = message;
    text.classList.remove('text-success', 'text-danger');
    text.classList.add(type === "success" ? 'text-success' : 'text-danger');
    card.classList.remove('hidden');
    card.style.transform = 'translateX(-50%) scale(1)';
    card.style.opacity = '1';
    setTimeout(() => {
      card.style.transform = 'translateX(-50%) scale(0.8)';
      card.style.opacity = '0';
      setTimeout(() => card.classList.add('hidden'), 300);
    }, duration);
  }

  // ===== STATE ===== //
  const codeInputs = document.querySelectorAll('.code-inputs .code');
  let timerInterval;
  let resendCooldown = 0;
  let resendAttempts = 0;
  const maxResends = 3;

  function startCooldown() {
    if (resendAttempts === 1) resendCooldown = 30;
    else if (resendAttempts === 2) resendCooldown = 300;
    else if (resendAttempts === 3) resendCooldown = 600;
    else return;

    document.getElementById('btnResend').classList.add('disabled');

    timerInterval = setInterval(() => {
      if (resendCooldown <= 0) {
        clearInterval(timerInterval);
        document.getElementById('resendTimer').innerText = "";
        if (resendAttempts < maxResends) {
          document.getElementById('btnResend').classList.remove('disabled');
        }
      } else {
        document.getElementById('resendTimer').innerText = ` (wait ${resendCooldown}s)`;
        resendCooldown--;
      }
    }, 1000);
  }

  // ===== SEND CODE ===== //
  document.getElementById('btnSendCode').addEventListener('click', async () => {
    const email = document.getElementById('loginEmail').value.trim();
    if (!email) return showAlert("Email is required", "error");

    try {
      const res = await fetch("/resend_code", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('loginStep1').classList.add('hidden');
        const step2 = document.getElementById('loginStep2');
        step2.classList.remove('hidden');
        step2.classList.add('fade-in');
        document.getElementById('verifyEmailText').innerText = email;
        resendAttempts = 1;
        startCooldown();
        showAlert("Code sent to your email", "success");
      } else {
        showAlert(data.error || "Failed to send code", "error");
      }
    } catch (err) {
      console.error(err);
      showAlert("Error sending code", "error");
    }
  });

  // ===== RESEND CODE ===== //
  document.getElementById('btnResend').addEventListener('click', async (e) => {
    e.preventDefault();
    if (resendCooldown > 0) return;
    if (resendAttempts >= maxResends) {
      showAlert("You have reached the maximum number of resends", 'error');
      return;
    }

    const email = document.getElementById('verifyEmailText').innerText;
    try {
      const res = await fetch("/resend_code", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if (data.success) {
        resendAttempts++;
        showAlert(`New code sent (Attempt ${resendAttempts}/${maxResends})`, 'success');
        startCooldown();
      } else {
        showAlert(data.error || "Failed to resend code", 'error');
      }
    } catch (err) {
      console.error(err);
      showAlert("Error resending code", 'error');
    }
  });

  // ===== CODE INPUT SMART HANDLING ===== //
  codeInputs.forEach((input, idx) => {
    input.addEventListener('input', (e) => {
      const value = e.target.value;
      if (value.length > 1) {
        for (let i = 0; i < codeInputs.length; i++) {
          codeInputs[i].value = value[i] || "";
        }
        codeInputs[codeInputs.length - 1].focus();
        return;
      }
      if (value && idx < codeInputs.length - 1) {
        codeInputs[idx + 1].focus();
      }
    });
    input.addEventListener('keydown', (e) => {
      if (e.key === "Backspace" && !input.value && idx > 0) {
        codeInputs[idx - 1].focus();
      }
    });
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text');
      if (!/^\d{6}$/.test(paste)) return;
      for (let i = 0; i < codeInputs.length; i++) {
        codeInputs[i].value = paste[i];
      }
      codeInputs[codeInputs.length - 1].focus();
    });
  });

  // ===== VERIFY CODE ===== //
  const btnVerify = document.getElementById('btnVerify');
btnVerify.addEventListener('click', async () => {
    const code = document.getElementById('verificationCode').value.trim();
    const email = document.getElementById('verifyEmailText').innerText;
    if (!code) {
        showAlert("Enter your code", 'error');
        return;
    }
    try {
        const res = await fetch("/verify_code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, code })
        });
        const data = await res.json();
        if (data.success) {
            window.location.href = "/leaderboard";
        } else {
            showAlert(data.error || "Invalid code", 'error');
        }
    } catch (err) {
        console.error(err);
        showAlert("Verification failed", 'error');
    }
});

</script>
{% endblock %}
