<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iTrade Journal â€” Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --brand-500: #2F6BFF;
      --brand-600: #1F55E0;
      --success: #22C55E;
      --danger: #EF4444;
      --bg: #F8FAFC;
      --surface: #FFFFFF;
      --text: #1E293B;
      --muted: #64748B;
      --border: #E2E8F0;
      --radius: 12px;
      --card-shadow: 0 4px 12px rgba(15,23,42,0.06);
      --card-shadow-strong: 0 8px 24px rgba(15,23,42,0.12);
      --accent: #06B6D4;
    }
    [data-theme="dark"] {
      --bg: #0B0F16;
      --surface: #0F1724;
      --text: #E5E7EB;
      --muted: #94A3B8;
      --border: rgba(148,163,184,0.18);
    }

    html, body { height: 100%; margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    body { background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

    .nav-link {
      position: relative;
      color: var(--muted);
      font-weight: 500;
      padding-bottom: 6px;
      transition: color .25s ease;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: 0;
      transform-origin: center;
      transform: translateX(-50%) scaleX(0);
      width: 60%;
      height: 2px;
      background: var(--brand-500);
      border-radius: 2px;
      transition: transform .25s ease;
    }
    .nav-link:hover::after, .nav-link.active::after {
      transform: translateX(-50%) scaleX(1);
    }

    @media (max-width: 991px) {
      .offcanvas .nav-link {
        padding-left: 12px;
        padding-right: 12px;
        padding-bottom: 8px;
      }
      .offcanvas .nav-link::after {
        left: 0;
        transform-origin: left center;
        width: 100%;
        transform: scaleX(0);
      }
      .offcanvas .nav-link:hover::after, .offcanvas .nav-link.active::after {
        transform: scaleX(1);
      }
      .offcanvas .navbar-nav { gap: 8px; }
    }

    .notif-dot { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; }
    .user-avatar { font-size: 0.85rem; text-transform: uppercase; cursor: pointer; transition: transform .2s ease; }
    .user-avatar:hover { transform: scale(1.1); }
    .container-main { max-width: 1200px; margin: 0 auto; padding: 22px; }
    .brand { color: var(--brand-500); font-weight: 700; font-size: 1.125rem; }
    #themeBtn { width: 40px; height: 40px; border-radius: 999px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; background: var(--surface); color: var(--muted); }

    .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .admin-card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--card-shadow); border: 1px solid var(--border); padding: 20px; }
    .admin-card h5 { margin-bottom: 15px; color: var(--text); font-weight: 600; }
    .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .stat-item:last-child { border-bottom: none; }
    .stat-label { color: var(--muted); font-size: .9rem; }
    .stat-value { font-weight: 600; color: var(--text); }

    .table-admin th { font-weight: 600; color: var(--text); }
    .table-admin td { color: var(--muted); }
    .badge-starter { background: rgba(34,197,94,0.1); color: var(--success); }
    .badge-pro { background: rgba(47,107,255,0.1); color: var(--brand-500); }
    .badge-elite { background: rgba(6,182,212,0.1); color: var(--accent); }
    .btn-admin-sm { padding: 4px 8px; font-size: .8rem; }
    .table-trades th { font-weight: 600; color: var(--text); }
    .table-trades td { color: var(--muted); }
    .plan-dist { height: 200px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted); }
    .pricing-form-group, .discount-form-group, .eligibility-form-group, .upload-limits-form-group { margin-bottom: 1rem; }
    .pricing-input, .discount-input, .eligibility-input, .upload-limits-input { width: 120px; display: inline-block; }
    .save-pricing, .save-discount, .save-eligibility, .save-upload-limits { margin-top: 1rem; }
    .metric-positive { color: var(--success); }
    .metric-negative { color: var(--danger); }
    .metric-neutral { color: var(--text); }
    .fade-up { animation: fadeUp .28s ease both; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--card-shadow-strong);
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast i { font-size: 1.25rem; }

    @media (max-width: 768px) { .container-main { padding: 14px; } }

    /* NEW: Test Sub Modal Styles */
    #testSubModal .modal-content { border-radius: var(--radius); }
    #testSubModal .form-select { max-width: 300px; }

    /* UPDATED: Test Access List Styles */
    .test-access-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 8px;
      background: rgba(47,107,255,0.05);
      border-radius: 6px;
      margin-bottom: 4px;
      font-size: 0.875rem;
    }
    .test-access-item .text-muted { font-size: 0.8rem; }

    /* NEW: Partial Payment Styles */
    .partial-progress { background: rgba(34,197,94,0.1); color: var(--success); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
  </style>
</head>
<body>
  <!-- NAVBAR (unchanged) -->
  <nav class="navbar sticky-top" style="background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: 0 2px 6px rgba(15,23,42,0.06);">
    <div class="container-fluid px-3 d-flex justify-content-between align-items-center">
      <a class="navbar-brand fw-bold fs-5 text-primary d-flex align-items-center gap-2" href="/">
        <i class="bi bi-graph-up-arrow"></i> iTrade
      </a>
      <ul class="navbar-nav d-none d-lg-flex flex-row align-items-center gap-3">
        <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/journal">Journal</a></li>
        <li class="nav-item"><a class="nav-link" href="/upload">Upload</a></li>
        <li class="nav-item"><a class="nav-link" href="/insights">Insights</a></li>
        <li class="nav-item"><a class="nav-link" href="/profile">Profile</a></li>
        <li class="nav-item"><a class="nav-link active" href="/admin">Admin</a></li>
      </ul>
      <div class="d-none d-lg-flex align-items-center gap-3">
        <div class="dropdown">
          <a class="nav-link position-relative" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell fs-5"></i>
            <span class="notif-dot"></span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm rounded-3 p-2">
            <li class="dropdown-header fw-semibold text-muted">Notifications</li>
            <li><a class="dropdown-item small py-2 rounded" href="#">Trade #102 logged</a></li>
            <li><a class="dropdown-item small py-2 rounded" href="#">AI insight ready</a></li>
          </ul>
        </div>
        <button id="themeToggle" class="btn btn-outline-secondary btn-sm"><i class="bi bi-moon"></i></button>
        <div class="dropdown">
          <a class="nav-link p-0" href="#" data-bs-toggle="dropdown">
            <div class="user-avatar rounded-circle d-flex justify-content-center align-items-center text-white fw-bold" style="width:32px; height:32px; background:#2F6BFF;">
              {{ initials }}
            </div>
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm rounded-3 mt-2">
            <li><a class="dropdown-item" href="/profile">Profile</a></li>
            <li><a class="dropdown-item" href="/plans">Upgrade</a></li>
            <li><a class="dropdown-item text-danger" href="/users/logout">Logout</a></li>
          </ul>
        </div>
      </div>
      <button class="navbar-toggler d-lg-none border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNav">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNav">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Menu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav gap-2">
          <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="/journal">Journal</a></li>
          <li class="nav-item"><a class="nav-link" href="/upload">Upload</a></li>
          <li class="nav-item"><a class="nav-link" href="/insights">Insights</a></li>
          <li class="nav-item"><a class="nav-link" href="/profile">Profile</a></li>
          <li class="nav-item"><a class="nav-link active" href="/admin">Admin</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container-main">
    <div class="position-relative fade-up" style="margin-bottom:18px">
      <div>
        <div style="font-size:1rem;color:var(--muted)">Admin Panel</div>
        <div style="font-size:1.6rem;font-weight:700">System Overview</div>
      </div>
    </div>

<!-- STATS GRID (unchanged) -->
<section class="admin-grid mb-4 fade-up">
  <div class="admin-card">
    <h5><i class="bi bi-people-fill text-primary me-2"></i>Total Users</h5>
    <div class="stat-item">
      <span class="stat-label">Active Users</span>
      <span class="stat-value">{{ total_users }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">New This Week</span>
      <span class="stat-value">{{ new_users }}</span>
    </div>
  </div>
  <div class="admin-card">
    <h5><i class="bi bi-graph-up-arrow text-success me-2"></i>Total Trades</h5>
    <div class="stat-item">
      <span class="stat-label">All Trades</span>
      <span class="stat-value">{{ total_trades }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Avg per User</span>
      <span class="stat-value">{{ avg_trades_per_user }}</span>
    </div>
  </div>
  <div class="admin-card">
    <h5><i class="bi bi-credit-card text-info me-2"></i>Plan Distribution</h5>
    <div class="stat-item">
      <span class="stat-label">Starter</span>
      <span class="stat-value badge badge-starter">{{ plan_counts.starter }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Pro</span>
      <span class="stat-value badge badge-pro">{{ plan_counts.pro }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Elite</span>
      <span class="stat-value badge badge-elite">{{ plan_counts.elite }}</span>
    </div>
  </div>
  <div class="admin-card">
    <h5><i class="bi bi-currency-dollar text-warning me-2"></i>MRR</h5>
    <div class="stat-item">
      <span class="stat-label">Monthly Recurring Revenue</span>
      <span class="stat-value metric-positive">${{ "%.2f"|format(mrr) }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Monthly Revenue</span>
      <span class="stat-value metric-positive">${{ "%.2f"|format(monthly_revenue) }}</span>
    </div>
  </div>
  <div class="admin-card">
    <h5><i class="bi bi-arrow-down-circle text-danger me-2"></i>Churn Metrics</h5>
    <div class="stat-item">
      <span class="stat-label">User Churn Rate</span>
      <span class="stat-value metric-negative">{{ "%.1f"|format(user_churn_rate) }}%</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Revenue Churn Rate</span>
      <span class="stat-value metric-negative">{{ "%.1f"|format(revenue_churn_rate) }}%</span>
    </div>
  </div>
  <div class="admin-card">
    <h5><i class="bi bi-graph-down text-secondary me-2"></i>ARPU</h5>
    <div class="stat-item">
      <span class="stat-label">Avg Revenue Per User</span>
      <span class="stat-value metric-neutral">${{ "%.2f"|format(arpu) }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Active Subscribers</span>
      <span class="stat-value">{{ active_subscribers }}</span>
    </div>
  </div>
</section>

<!-- UPDATED: ELIGIBILITY CONFIG CARD -->
<div class="admin-card fade-up mb-4">
  <h5><i class="bi bi-shield-check text-success me-2"></i>Marketplace Eligibility</h5>
  <form id="eligibilityForm">
    <div class="eligibility-form-group">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-semibold">Minimum Trades</label>
          <input type="number" class="form-control eligibility-input" name="min_trades" value="{{ eligibility.min_trades }}" min="1" required>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Minimum Win Rate (%)</label>
          <input type="number" class="form-control eligibility-input" name="min_win_rate" value="{{ eligibility.min_win_rate }}" min="0" max="100" step="0.1" required>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold">Max Marketplace Price ($)</label>
          <input type="number" class="form-control eligibility-input" name="max_marketplace_price" value="{{ eligibility.max_marketplace_price }}" step="0.01" min="0" required>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary save-eligibility">Update Eligibility</button>
  </form>
  <div class="alert alert-info mt-3">
    <small><i class="bi bi-info-circle me-1"></i>Only users meeting these criteria can be enabled as marketplace traders.</small>
  </div>
</div>

<!-- NEW: UPLOAD LIMITS CARD -->
<div class="admin-card fade-up mb-4">
  <h5><i class="bi bi-upload text-info me-2"></i>Upload Limits</h5>
  <form id="uploadLimitsForm">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label fw-semibold">Starter Monthly</label>
        <input type="number" class="form-control upload-limits-input" name="starter_monthly" value="{{ upload_limits.starter.monthly_limit }}" min="0" required>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Starter Batch</label>
        <input type="number" class="form-control upload-limits-input" name="starter_batch" value="{{ upload_limits.starter.batch_limit }}" min="1" required>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Pro Monthly</label>
        <input type="number" class="form-control upload-limits-input" name="pro_monthly" value="{{ upload_limits.pro.monthly_limit }}" min="0" required>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Pro Batch</label>
        <input type="number" class="form-control upload-limits-input" name="pro_batch" value="{{ upload_limits.pro.batch_limit }}" min="1" required>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Elite Monthly</label>
        <input type="number" class="form-control upload-limits-input" name="elite_monthly" value="{{ upload_limits.elite.monthly_limit }}" min="0" required>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Elite Batch</label>
        <input type="number" class="form-control upload-limits-input" name="elite_batch" value="{{ upload_limits.elite.batch_limit }}" min="1" required>
      </div>
    </div>
    <button type="submit" class="btn btn-primary save-upload-limits mt-3">Save Upload Limits</button>
  </form>
  <div class="alert alert-info mt-3">
    <small><i class="bi bi-info-circle me-1"></i>Configure monthly upload quotas and batch sizes per plan. Use a very high number (e.g., 999999) for unlimited.</small>
  </div>
</div>

<!-- PRICING, DISCOUNT, MARKETPLACE DISCOUNT CARDS (unchanged) -->
<div class="admin-card fade-up mb-4">
  <h5><i class="bi bi-currency-dollar text-warning me-2"></i>Plan Pricing</h5>
  <form id="pricingForm">
    <div class="pricing-form-group">
      <label class="form-label fw-semibold">Pro Plan</label>
      <div class="d-flex align-items-center gap-3">
        <div>
          <label class="form-label small text-muted">Monthly</label>
          <input type="number" class="form-control pricing-input" name="pro_monthly" value="{{ pricing.pro_monthly }}" step="0.01" required>
        </div>
        <div>
          <label class="form-label small text-muted">Yearly</label>
          <input type="number" class="form-control pricing-input" name="pro_yearly" value="{{ pricing.pro_yearly }}" step="0.01" required>
        </div>
      </div>
    </div>
    <div class="pricing-form-group">
      <label class="form-label fw-semibold">Elite Plan</label>
      <div class="d-flex align-items-center gap-3">
        <div>
          <label class="form-label small text-muted">Monthly</label>
          <input type="number" class="form-control pricing-input" name="elite_monthly" value="{{ pricing.elite_monthly }}" step="0.01" required>
        </div>
        <div>
          <label class="form-label small text-muted">Yearly</label>
          <input type="number" class="form-control pricing-input" name="elite_yearly" value="{{ pricing.elite_yearly }}" step="0.01" required>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary save-pricing">Save Pricing</button>
  </form>
</div>

<div class="admin-card fade-up mb-4">
  <h5><i class="bi bi-ticket-perforated text-success me-2"></i>Platform Discount Management</h5>
  <form id="discountForm">
    <div class="discount-form-group">
      <label class="form-label fw-semibold">Discount Settings</label>
      <div class="d-flex align-items-center gap-3">
        <div>
          <label class="form-label small text-muted">Enable Discount</label>
          <input type="checkbox" class="form-check-input" name="discount_enabled" {% if discount.enabled %}checked{% endif %}>
        </div>
        <div>
          <label class="form-label small text-muted">Discount Percentage (%)</label>
          <input type="number" class="form-control discount-input" name="discount_percentage" value="{{ discount.percentage }}" step="0.1" min="0" max="100" {% if not discount.enabled %}disabled{% endif %}>
        </div>
        <div>
          <label class="form-label small text-muted">Valid Until (Optional)</label>
          <input type="date" class="form-control discount-input" name="discount_expiry" value="{{ discount.expiry|default('') }}" {% if not discount.enabled %}disabled{% endif %}>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary save-discount">Save Discount</button>
  </form>
  <div class="alert alert-info mt-3">
    <small><i class="bi bi-info-circle me-1"></i>Discount applies as a first-month reduction to new platform subscriptions.</small>
  </div>
</div>

<div class="admin-card fade-up mb-4">
  <h5><i class="bi bi-shop text-info me-2"></i>Marketplace Discount Management</h5>
  <form id="marketplaceDiscountForm">
    <div class="discount-form-group">
      <label class="form-label fw-semibold">Discount Settings</label>
      <div class="d-flex align-items-center gap-3">
        <div>
          <label class="form-label small text-muted">Enable Discount</label>
          <input type="checkbox" class="form-check-input" name="marketplace_discount_enabled" {% if marketplace_discount.enabled %}checked{% endif %}>
        </div>
        <div>
          <label class="form-label small text-muted">Discount Percentage (%)</label>
          <input type="number" class="form-control discount-input" name="marketplace_discount_percentage" value="{{ marketplace_discount.percentage }}" step="0.1" min="0" max="100" {% if not marketplace_discount.enabled %}disabled{% endif %}>
        </div>
        <div>
          <label class="form-label small text-muted">Valid Until (Optional)</label>
          <input type="date" class="form-control discount-input" name="marketplace_discount_expiry" value="{{ marketplace_discount.expiry|default('') }}" {% if not marketplace_discount.enabled %}disabled{% endif %}>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary save-marketplace-discount">Save Marketplace Discount</button>
  </form>
  <div class="alert alert-info mt-3">
    <small><i class="bi bi-info-circle me-1"></i>Discount applies as a first-month reduction to new marketplace subscriptions.</small>
  </div>
</div>

<!-- NEW: RECENT PARTIAL PAYMENTS -->
<div class="admin-card fade-up mb-4">
  <h5><i class="bi bi-credit-card-2-front text-warning me-2"></i>Recent Partial Payments</h5>
  <div class="table-responsive">
    <table class="table table-admin table-hover">
      <thead>
        <tr>
          <th>Payment ID</th>
          <th>User</th>
          <th>Trader</th>
          <th>Expected ($)</th>
          <th>Paid (Crypto)</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for payment in recent_partial_payments %}
        <tr>
          <td>{{ payment.nowpayments_payment_id }}</td>
          <td>{{ payment.user_email }} (ID: {{ payment.user_id }})</td>
          <td>{% if payment.is_marketplace %}{{ payment.trader_name }}{% else %}<span class="text-muted">Platform</span>{% endif %}</td>
          <td>${{ "%.2f"|format(payment.amount_usd) }}</td>
          <td>{{ payment.amount_paid_crypto }} {{ payment.crypto_currency }}</td>
          <td>{{ payment.created }}</td>
          <td>
            <button class="btn btn-sm btn-success btn-admin-sm" data-bs-toggle="modal" data-bs-target="#completePaymentModal" onclick="openCompleteModal('{{ payment.nowpayments_payment_id }}', '{{ payment.user_email }}')">
              <i class="bi bi-check-lg"></i> Complete
            </button>
          </td>
        </tr>
        {% endfor %}
        {% if not recent_partial_payments %}
        <tr><td colspan="7" class="text-center text-muted">No partial payments</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- UPDATED: RECENT USERS WITH TRADER TOGGLE & PENDING STATUS -->
<div class="admin-card fade-up mb-4">
  <h5><i class="bi bi-person-lines-fill text-warning me-2"></i>Recent Users</h5>
  <div class="table-responsive">
    <table class="table table-admin table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Email</th>
          <th>Full Name</th>
          <th>Joined</th>
          <th>Trades</th>
          <th>Plan</th>
          <th>Trader</th>
          <th>Test Access</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in recent_users %}
        <tr>
          <td>{{ user.id }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.full_name }}</td>
          <td>{{ user.joined }}</td>
          <td>{{ user.trades }}</td>
          <td><span class="badge badge-{{ user.plan.lower() }} px-2 py-1">{{ user.plan }}</span></td>

      <!-- TRADER TOGGLE WITH PENDING STATUS -->
      <td>
        <div class="form-check form-switch d-inline-block">
          <input
            class="form-check-input trader-toggle"
            type="checkbox"
            id="trader-{{ user.id }}"
            data-user-id="{{ user.id }}"
            data-min-trades="{{ eligibility.min_trades }}"
            data-min-win-rate="{{ eligibility.min_win_rate }}"
            {% if user.is_trader %}checked{% endif %}
          >
          <label class="form-check-label" for="trader-{{ user.id }}"></label>
        </div>
        <small class="ms-1 eligibility-msg" data-user-id="{{ user.id }}">
          {% if user.is_trader_pending %}
            <span class="text-warning">Pending Review</span>
          {% elif user.is_trader %}
            <span class="text-success">Live ({{ "%.1f"|format(user.win_rate) }}% win)</span>
          {% else %}
            {% if user.trades < eligibility.min_trades %}
              <span class="text-muted">Need {{ eligibility.min_trades - user.trades }} more trades</span>
            {% elif user.win_rate < eligibility.min_win_rate %}
              <span class="text-muted">Win-rate {{ "%.1f"|format(user.win_rate) }}%</span>
            {% else %}
              <span class="text-success">Eligible</span>
            {% endif %}
          {% endif %}
        </small>
      </td>

      <!-- TEST ACCESS COLUMN (unchanged) -->
      <td>
        {% if user.sub_list %}
          {% for sub in user.sub_list %}
          <div class="test-access-item">
            <span class="text-muted">{{ sub.trader_name }}</span>
            <button class="btn btn-sm btn-outline-danger" onclick="revokeTestAccess({{ user.id }}, {{ sub.trader_id }})">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          {% endfor %}
        {% else %}
          <span class="text-muted small">No access</span>
        {% endif %}
        <button class="btn btn-sm btn-outline-primary btn-admin-sm mt-2 w-100" data-bs-toggle="modal" data-bs-target="#testSubModal" onclick="openTestSubModal({{ user.id }}, '{{ (user.full_name or user.email)|e }}')">
          <i class="bi bi-plus-circle"></i> Grant
        </button>
      </td>

      <td>
        <select id="plan-{{ user.id }}" class="form-select form-select-sm d-inline-block w-auto" style="width:auto;">
          <option value="starter" {% if user.plan.lower() == 'starter' %}selected{% endif %}>Starter</option>
          <option value="pro" {% if user.plan.lower() == 'pro' %}selected{% endif %}>Pro</option>
          <option value="elite" {% if user.plan.lower() == 'elite' %}selected{% endif %}>Elite</option>
        </select>
        <button onclick="updatePlan({{ user.id }})" class="btn btn-sm btn-primary btn-admin-sm ms-1">Update</button>
      </td>
    </tr>
    {% endfor %}
    {% if not recent_users %}
    <tr><td colspan="9" class="text-center text-muted">No users found</td></tr>
    {% endif %}
  </tbody>
</table>  </div>
</div>

<!-- MARKETPLACE TRADERS (unchanged) -->
{% if marketplace_traders %}<div class="admin-card fade-up mb-4">
  <h5><i class="bi bi-shop-window text-info me-2"></i>Marketplace Traders</h5>
  <div class="table-responsive">
    <table class="table table-admin table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Win Rate</th>
          <th>Trades</th>
          <th>Price ($/mo)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for trader in marketplace_traders %}
        <tr>
          <td>{{ trader.id }}</td>
          <td>{{ trader.name }}</td>
          <td>{{ trader.win_rate }}%</td>
          <td>{{ trader.trades }}</td>
          <td id="price-display-{{ trader.id }}">${{ "%.2f"|format(trader.price) }}</td>
          <td>
            <input type="number" class="form-control form-control-sm d-inline-block w-auto" id="price-{{ trader.id }}" value="{{ trader.price }}" step="0.01" min="0" style="width:100px;">
            <button onclick="updateMarketplacePrice({{ trader.id }})" class="btn btn-sm btn-primary btn-admin-sm ms-1">Update</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- NEW: PENDING TRADER APPLICATIONS -->
<div class="admin-card fade-up mb-4">
  <h5><i class="bi bi-clock-history text-warning me-2"></i>Pending Trader Applications</h5>
  <div class="table-responsive">
    <table class="table table-admin table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Win Rate</th>
          <th>Trades</th>
          <th>Applied</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for trader in pending_traders %}
        <tr>
          <td>{{ trader.id }}</td>
          <td>{{ trader.name }}</td>
          <td>{{ trader.email }}</td>
          <td>{{ trader.win_rate }}%</td>
          <td>{{ trader.trades }}</td>
          <td>{{ trader.applied_at }}</td>
          <td>
            <button class="btn btn-sm btn-success btn-admin-sm me-1" onclick="approveTrader({{ trader.id }})">Approve</button>
            <button class="btn btn-sm btn-outline-danger btn-admin-sm" data-bs-toggle="modal" data-bs-target="#rejectModal" onclick="openRejectModal({{ trader.id }}, '{{ trader.name|e }}')">Reject</button>
          </td>
        </tr>
        {% endfor %}
        {% if not pending_traders %}
        <tr><td colspan="7" class="text-center text-muted">No pending applications</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- RECENT TRADES (unchanged) -->
<div class="admin-card fade-up">
  <h5><i class="bi bi-arrow-repeat text-primary me-2"></i>Recent Trades</h5>
  <div class="table-responsive">
    <table class="table table-trades table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Symbol</th>
          <th>PnL</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for trade in recent_trades %}
        <tr class="{% if trade.pnl >= 0 %}table-success{% else %}table-danger{% endif %}">
          <td>{{ trade.id }}</td>
          <td>{{ trade.user_name }}</td>
          <td>{{ trade.symbol }}</td>
          <td class="{% if trade.pnl >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">{{ trade.pnl }}</td>
          <td>{{ trade.created }}</td>
          <td><button class="btn btn-sm btn-outline-secondary btn-admin-sm">View</button></td>
        </tr>
        {% endfor %}
        {% if not recent_trades %}
        <tr>
          <td colspan="6" class="text-center text-muted">No trades found</td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- TEST SUB MODAL (unchanged) -->
<div class="modal fade" id="testSubModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Grant Test Marketplace Access</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Grant <strong id="modalUserName"></strong> access to a trader's journal for testing.</p>
        <select id="traderSelect" class="form-select">
          <option value="">Select Trader</option>
          {% for trader in marketplace_traders %}
          <option value="{{ trader.id }}">{{ trader.name }} ({{ trader.win_rate }}% win, ${{ trader.price }}/mo)</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="grantTestAccess">Grant Access</button>
      </div>
    </div>
  </div>
</div>

<!-- NEW: REJECT MODAL -->
<div class="modal fade" id="rejectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reject Trader Application</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Reject <strong id="rejectTraderName"></strong>'s application?</p>
        <div class="mb-3">
          <label class="form-label">Rejection Reason (Optional)</label>
          <textarea class="form-control" id="rejectReason" rows="3" placeholder="Enter reason for rejection..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="rejectTraderBtn">Reject Application</button>
      </div>
    </div>
  </div>
</div>

<!-- NEW: COMPLETE PAYMENT MODAL -->
<div class="modal fade" id="completePaymentModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Complete Partial Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Manually complete payment for <strong id="completeUserEmail"></strong>?</p>
        <div class="mb-3">
          <label class="form-label">Payment ID</label>
          <input type="text" class="form-control" id="completePaymentId" readonly>
        </div>
        <div class="mb-3">
          <label class="form-label">Reason (Optional)</label>
          <textarea class="form-control" id="completeReason" rows="2" placeholder="e.g., Test partial payment, fee adjustment..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="completePaymentBtn">Complete Payment</button>
      </div>
    </div>
  </div>
</div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Toast Notification (unchanged)
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type} show`;
      toast.innerHTML = `
        <i class="bi ${type === 'success' ? 'bi-check-circle-fill text-success' : 'bi-exclamation-triangle-fill text-danger'}"></i>
        <div>${message}</div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Theme toggle (unchanged)
    document.getElementById('themeToggle').addEventListener('click', () => {
      const html = document.documentElement;
      const icon = document.querySelector('#themeToggle i');
      if (html.getAttribute('data-theme') === 'dark') {
        html.setAttribute('data-theme', 'light');
        icon.classList.replace('bi-sun', 'bi-moon');
      } else {
        html.setAttribute('data-theme', 'dark');
        icon.classList.replace('bi-moon', 'bi-sun');
      }
    });

    // Update Plan (unchanged)
    function updatePlan(userId) {
      const select = document.getElementById(`plan-${userId}`);
      const plan = select.value;
      fetch(`/admin/update_plan/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `plan=${plan}`
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast('Plan updated successfully!');
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.message || 'Failed to update plan', 'error');
        }
      })
      .catch(() => showToast('Network error', 'error'));
    }

    // Pricing Form (updated with reload on success)
    document.getElementById('pricingForm').addEventListener('submit', e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      fetch('/admin/update_pricing', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            showToast('Pricing saved!');
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast('Failed to save pricing', 'error');
          }
        })
        .catch(() => showToast('Network error', 'error'));
    });

    // Platform Discount Form (updated with reload on success)
    document.getElementById('discountForm').addEventListener('submit', e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      fetch('/admin/update_discount', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            showToast('Discount saved!');
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast('Failed to save discount', 'error');
          }
        })
        .catch(() => showToast('Network error', 'error'));
    });

    // Marketplace Discount Form (updated with reload on success)
    document.getElementById('marketplaceDiscountForm').addEventListener('submit', e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      fetch('/admin/update_marketplace_discount', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            showToast('Marketplace discount saved!');
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast('Failed to save marketplace discount', 'error');
          }
        })
        .catch(() => showToast('Network error', 'error'));
    });

    // NEW: Upload Limits Form
    document.getElementById('uploadLimitsForm').addEventListener('submit', e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      fetch('/admin/update_upload_limits', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            showToast('Upload limits saved!');
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast('Failed to save upload limits', 'error');
          }
        })
        .catch(() => showToast('Network error', 'error'));
    });

    // Eligibility Form (updated with reload on success)
    document.getElementById('eligibilityForm').addEventListener('submit', async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

      try {
        const resp = await fetch('/admin/update_eligibility', { method: 'POST', body: fd });
        const data = await resp.json();
        if (data.success) {
          showToast(data.message);
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.detail || 'Failed', 'error');
        }
      } catch {
        showToast('Network error', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Update Eligibility';
      }
    });

    // Enable/disable discount inputs (unchanged)
    document.querySelector('input[name="discount_enabled"]').addEventListener('change', function () {
      const inputs = document.querySelectorAll('#discountForm .discount-input');
      inputs.forEach(i => i.disabled = !this.checked);
    });

    // Enable/disable marketplace discount inputs (unchanged)
    document.querySelector('input[name="marketplace_discount_enabled"]').addEventListener('change', function () {
      const inputs = document.querySelectorAll('#marketplaceDiscountForm .discount-input');
      inputs.forEach(i => i.disabled = !this.checked);
    });

    // Trader Toggle with Dynamic Feedback (unchanged)
    document.querySelectorAll('.trader-toggle').forEach(toggle => {
      toggle.addEventListener('change', async function () {
        const userId = this.dataset.userId;
        const minTrades = parseInt(this.dataset.minTrades);
        const minWinRate = parseFloat(this.dataset.minWinRate);
        const desiredOn = this.checked;
        const small = this.closest('td').querySelector('.eligibility-msg');

        this.disabled = true;

        try {
          const resp = await fetch(`/admin/toggle_trader/${userId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `desired_is_trader=${desiredOn}`
          });
          const data = await resp.json();

          if (!data.success) throw new Error(data.detail || 'Failed');

          // Update UI based on server response
          if (data.is_trader) {
            small.innerHTML = `<span class="text-success">Live (${data.win_rate.toFixed(1)}% win)</span>`;
          } else {
            let msg = '';
            if (data.total_trades < minTrades) {
              msg = `Need ${minTrades - data.total_trades} more trades`;
            } else if (data.win_rate < minWinRate) {
              msg = `Win-rate ${data.win_rate.toFixed(1)}%`;
            } else {
              msg = 'Eligible';
            }
            small.innerHTML = `<span class="${data.eligible ? 'text-success' : 'text-muted'}">${msg}</span>`;
          }

          showToast(`Trader ${data.is_trader ? 'enabled' : 'disabled'}`);
        } catch (e) {
          showToast(e.message, 'error');
          this.checked = !desiredOn;
        } finally {
          this.disabled = false;
        }
      });
    });

    // Update Marketplace Price (unchanged)
    function updateMarketplacePrice(userId) {
      const input = document.getElementById(`price-${userId}`);
      const price = parseFloat(input.value);
      if (isNaN(price) || price < 0) {
        showToast('Invalid price', 'error');
        return;
      }
      fetch(`/admin/update_marketplace_price/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `price=${price}`
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast('Price updated successfully!');
          const priceCell = document.getElementById(`price-display-${userId}`);
          priceCell.textContent = `$${price.toFixed(2)}`;
        } else {
          showToast(data.message || 'Failed to update price', 'error');
        }
      })
      .catch(() => showToast('Network error', 'error'));
    }

    // Test Sub Modal Functions (unchanged)
    let currentUserIdForModal = null;
    function openTestSubModal(userId, userName) {
      currentUserIdForModal = userId;
      const userNameEl = document.getElementById('modalUserName');
      userNameEl.textContent = userName;
      
      const select = document.getElementById('traderSelect');
      select.value = '';
    }

    document.getElementById('grantTestAccess').addEventListener('click', async () => {
      const traderId = parseInt(document.getElementById('traderSelect').value);
      if (!traderId) {
        showToast('Select a trader', 'error');
        return;
      }
      
      const btn = document.getElementById('grantTestAccess');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Granting...';
      
      try {
        const res = await fetch('/admin/create_test_subscription', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `user_id=${currentUserIdForModal}&trader_id=${traderId}`
        });
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message);
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast(data.detail || 'Failed', 'error');
        }
      } catch (err) {
        showToast('Network error', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Grant Access';
        const modal = bootstrap.Modal.getInstance(document.getElementById('testSubModal'));
        modal.hide();
      }
    });

    // Revoke Test Access Function (unchanged)
    function revokeTestAccess(userId, traderId) {
      if (!confirm('Revoke test access to this trader\'s journal?')) return;
      
      fetch(`/admin/delete_test_subscription/${userId}/${traderId}`, { 
        method: 'DELETE' 
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast(data.message);
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.detail || 'Failed to revoke access', 'error');
        }
      })
      .catch(() => showToast('Network error', 'error'));
    }

    // NEW: Pending Trader Approval/Rejection Functions
    let currentTraderIdForReject = null;

    function openRejectModal(traderId, traderName) {
      currentTraderIdForReject = traderId;
      document.getElementById('rejectTraderName').textContent = traderName;
      document.getElementById('rejectReason').value = '';
    }

    function approveTrader(traderId) {
      if (!confirm('Approve this trader application?')) return;
      
      fetch(`/admin/approve_trader/${traderId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'approve=true'
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast(data.message);
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.detail || 'Failed to approve', 'error');
        }
      })
      .catch(() => showToast('Network error', 'error'));
    }

    document.getElementById('rejectTraderBtn').addEventListener('click', async () => {
      const reason = document.getElementById('rejectReason').value.trim();
      const btn = document.getElementById('rejectTraderBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Rejecting...';
      
      try {
        const res = await fetch(`/admin/approve_trader/${currentTraderIdForReject}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `approve=false&reason=${encodeURIComponent(reason)}`
        });
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message);
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast(data.detail || 'Failed', 'error');
        }
      } catch (err) {
        showToast('Network error', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Reject Application';
        const modal = bootstrap.Modal.getInstance(document.getElementById('rejectModal'));
        modal.hide();
      }
    });

    // NEW: Complete Payment Modal Functions
    let currentPaymentIdForComplete = null;
    function openCompleteModal(paymentId, userEmail) {
      currentPaymentIdForComplete = paymentId;
      document.getElementById('completePaymentId').value = paymentId;
      document.getElementById('completeUserEmail').textContent = userEmail;
      document.getElementById('completeReason').value = '';
    }

    document.getElementById('completePaymentBtn').addEventListener('click', async () => {
      const reason = document.getElementById('completeReason').value.trim() || 'Manual completion';
      const btn = document.getElementById('completePaymentBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Completing...';
      
      try {
        const res = await fetch('/admin/complete-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ payment_id: currentPaymentIdForComplete, reason: reason })
        });
        const data = await res.json();
        
        if (data.success) {
          showToast(data.message);
          setTimeout(() => location.reload(), 1500);
        } else {
          showToast(data.detail || 'Failed to complete payment', 'error');
        }
      } catch (err) {
        showToast('Network error', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'Complete Payment';
        const modal = bootstrap.Modal.getInstance(document.getElementById('completePaymentModal'));
        modal.hide();
      }
    });
  </script>
</body>
</html>