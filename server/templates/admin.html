<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>iTrade Journal â€” Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --brand-500: #2F6BFF;
      --brand-600: #1F55E0;
      --success: #22C55E;
      --danger: #EF4444;
      --bg: #F8FAFC;
      --surface: #FFFFFF;
      --text: #1E293B;
      --muted: #64748B;
      --border: #E2E8F0;
      --radius: 12px;
      --card-shadow: 0 4px 12px rgba(15,23,42,0.06);
      --card-shadow-strong: 0 8px 24px rgba(15,23,42,0.12);
      --accent: #06B6D4;
    }
    [data-theme="dark"] {
      --bg: #0B0F16;
      --surface: #0F1724;
      --text: #E5E7EB;
      --muted: #94A3B8;
      --border: rgba(148,163,184,0.18);
    }

    html, body { height: 100%; margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    body { background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

    .nav-link {
      position: relative;
      color: var(--muted);
      font-weight: 500;
      padding-bottom: 6px;
      transition: color .25s ease;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      left: 50%;
      bottom: 0;
      transform-origin: center;
      transform: translateX(-50%) scaleX(0);
      width: 60%;
      height: 2px;
      background: var(--brand-500);
      border-radius: 2px;
      transition: transform .25s ease;
    }
    .nav-link:hover::after, .nav-link.active::after {
      transform: translateX(-50%) scaleX(1);
    }

    @media (max-width: 991px) {
      .offcanvas .nav-link {
        padding-left: 12px;
        padding-right: 12px;
        padding-bottom: 8px;
      }
      .offcanvas .nav-link::after {
        left: 0;
        transform-origin: left center;
        width: 100%;
        transform: scaleX(0);
      }
      .offcanvas .nav-link:hover::after, .offcanvas .nav-link.active::after {
        transform: scaleX(1);
      }
      .offcanvas .navbar-nav { gap: 8px; }
    }

    .notif-dot { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; }
    .user-avatar { font-size: 0.85rem; text-transform: uppercase; cursor: pointer; transition: transform .2s ease; }
    .user-avatar:hover { transform: scale(1.1); }
    .container-main { max-width: 1200px; margin: 0 auto; padding: 22px; }
    .brand { color: var(--brand-500); font-weight: 700; font-size: 1.125rem; }
    #themeBtn { width: 40px; height: 40px; border-radius: 999px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; background: var(--surface); color: var(--muted); }

    .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .admin-card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--card-shadow); border: 1px solid var(--border); padding: 20px; }
    .admin-card h5 { margin-bottom: 15px; color: var(--text); font-weight: 600; }
    .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .stat-item:last-child { border-bottom: none; }
    .stat-label { color: var(--muted); font-size: .9rem; }
    .stat-value { font-weight: 600; color: var(--text); }

    .table-admin th { font-weight: 600; color: var(--text); }
    .table-admin td { color: var(--muted); }
    .badge-starter { background: rgba(34,197,94,0.1); color: var(--success); }
    .badge-pro { background: rgba(47,107,255,0.1); color: var(--brand-500); }
    .badge-elite { background: rgba(6,182,212,0.1); color: var(--accent); }
    .btn-admin-sm { padding: 4px 8px; font-size: .8rem; }
    .table-trades th { font-weight: 600; color: var(--text); }
    .table-trades td { color: var(--muted); }
    .plan-dist { height: 200px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted); }
    .pricing-form-group, .discount-form-group { margin-bottom: 1rem; }
    .pricing-input, .discount-input { width: 120px; display: inline-block; }
    .save-pricing, .save-discount { margin-top: 1rem; }
    .metric-positive { color: var(--success); }
    .metric-negative { color: var(--danger); }
    .metric-neutral { color: var(--text); }
    .fade-up { animation: fadeUp .28s ease both; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @media (max-width: 768px) { .container-main { padding: 14px; } }
  </style>
</head>
<body>
  <nav class="navbar sticky-top" style="background: var(--surface); border-bottom: 1px solid var(--border); box-shadow: 0 2px 6px rgba(15,23,42,0.06);">
    <div class="container-fluid px-3 d-flex justify-content-between align-items-center">
      <a class="navbar-brand fw-bold fs-5 text-primary d-flex align-items-center gap-2" href="/">
        <i class="bi bi-graph-up-arrow"></i> iTrade
      </a>
      <ul class="navbar-nav d-none d-lg-flex flex-row align-items-center gap-3">
        <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="/journal">Journal</a></li>
        <li class="nav-item"><a class="nav-link" href="/upload">Upload</a></li>
        <li class="nav-item"><a class="nav-link" href="/insights">Insights</a></li>
        <li class="nav-item"><a class="nav-link" href="/profile">Profile</a></li>
        <li class="nav-item"><a class="nav-link active" href="/admin">Admin</a></li>
      </ul>
      <div class="d-none d-lg-flex align-items-center gap-3">
        <div class="dropdown">
          <a class="nav-link position-relative" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-bell fs-5"></i>
            <span class="notif-dot"></span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm rounded-3 p-2">
            <li class="dropdown-header fw-semibold text-muted">Notifications</li>
            <li><a class="dropdown-item small py-2 rounded" href="#">âœ… Trade #102 logged</a></li>
            <li><a class="dropdown-item small py-2 rounded" href="#">ðŸ“Š AI insight ready</a></li>
          </ul>
        </div>
        <button id="themeToggle" class="btn btn-outline-secondary btn-sm"><i class="bi bi-moon"></i></button>
        <div class="dropdown">
          <a class="nav-link p-0" href="#" data-bs-toggle="dropdown">
            <div class="user-avatar rounded-circle d-flex justify-content-center align-items-center text-white fw-bold" style="width:32px; height:32px; background:#2F6BFF;">
              {{ initials }}
            </div>
          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow-sm rounded-3 mt-2">
            <li><a class="dropdown-item" href="/profile">Profile</a></li>
            <li><a class="dropdown-item" href="/plans">Upgrade</a></li>
            <li><a class="dropdown-item text-danger" href="/users/logout">Logout</a></li>
          </ul>
        </div>
      </div>
      <button class="navbar-toggler d-lg-none border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNav">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNav">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Menu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav gap-2">
          <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="/journal">Journal</a></li>
          <li class="nav-item"><a class="nav-link" href="/upload">Upload</a></li>
          <li class="nav-item"><a class="nav-link" href="/insights">Insights</a></li>
          <li class="nav-item"><a class="nav-link" href="/profile">Profile</a></li>
          <li class="nav-item"><a class="nav-link active" href="/admin">Admin</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container-main">
    <div class="position-relative fade-up" style="margin-bottom:18px">
      <div>
        <div style="font-size:1rem;color:var(--muted)">Admin Panel</div>
        <div style="font-size:1.6rem;font-weight:700">System Overview</div>
      </div>
    </div>

    <section class="admin-grid mb-4 fade-up">
      <div class="admin-card">
        <h5><i class="bi bi-people-fill text-primary me-2"></i>Total Users</h5>
        <div class="stat-item">
          <span class="stat-label">Active Users</span>
          <span class="stat-value">{{ total_users }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">New This Week</span>
          <span class="stat-value">{{ new_users }}</span>
        </div>
      </div>
      <div class="admin-card">
        <h5><i class="bi bi-graph-up-arrow text-success me-2"></i>Total Trades</h5>
        <div class="stat-item">
          <span class="stat-label">All Trades</span>
          <span class="stat-value">{{ total_trades }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Avg per User</span>
          <span class="stat-value">{{ avg_trades_per_user }}</span>
        </div>
      </div>
      <div class="admin-card">
        <h5><i class="bi bi-credit-card text-info me-2"></i>Plan Distribution</h5>
        <div class="stat-item">
          <span class="stat-label">Starter</span>
          <span class="stat-value badge badge-starter">{{ plan_counts.starter }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Pro</span>
          <span class="stat-value badge badge-pro">{{ plan_counts.pro }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Elite</span>
          <span class="stat-value badge badge-elite">{{ plan_counts.elite }}</span>
        </div>
      </div>
      <div class="admin-card">
        <h5><i class="bi bi-currency-dollar text-warning me-2"></i>MRR</h5>
        <div class="stat-item">
          <span class="stat-label">Monthly Recurring Revenue</span>
          <span class="stat-value metric-positive">${{ "%.2f"|format(mrr) }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Monthly Revenue</span>
          <span class="stat-value metric-positive">${{ "%.2f"|format(monthly_revenue) }}</span>
        </div>
      </div>
      <div class="admin-card">
        <h5><i class="bi bi-arrow-down-circle text-danger me-2"></i>Churn Metrics</h5>
        <div class="stat-item">
          <span class="stat-label">User Churn Rate</span>
          <span class="stat-value metric-negative">{{ "%.1f"|format(user_churn_rate) }}%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Revenue Churn Rate</span>
          <span class="stat-value metric-negative">{{ "%.1f"|format(revenue_churn_rate) }}%</span>
        </div>
      </div>
      <div class="admin-card">
        <h5><i class="bi bi-graph-down text-secondary me-2"></i>ARPU</h5>
        <div class="stat-item">
          <span class="stat-label">Avg Revenue Per User</span>
          <span class="stat-value metric-neutral">${{ "%.2f"|format(arpu) }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Active Subscribers</span>
          <span class="stat-value">{{ active_subscribers }}</span>
        </div>
      </div>
    </section>

    <div class="admin-card fade-up mb-4">
      <h5><i class="bi bi-currency-dollar text-warning me-2"></i>Plan Pricing</h5>
      <form id="pricingForm">
        <div class="pricing-form-group">
          <label class="form-label fw-semibold">Pro Plan</label>
          <div class="d-flex align-items-center gap-3">
            <div>
              <label class="form-label small text-muted">Monthly</label>
              <input type="number" class="form-control pricing-input" name="pro_monthly" value="{{ pricing.pro_monthly }}" step="0.01" required>
            </div>
            <div>
              <label class="form-label small text-muted">Yearly</label>
              <input type="number" class="form-control pricing-input" name="pro_yearly" value="{{ pricing.pro_yearly }}" step="0.01" required>
            </div>
          </div>
        </div>
        <div class="pricing-form-group">
          <label class="form-label fw-semibold">Elite Plan</label>
          <div class="d-flex align-items-center gap-3">
            <div>
              <label class="form-label small text-muted">Monthly</label>
              <input type="number" class="form-control pricing-input" name="elite_monthly" value="{{ pricing.elite_monthly }}" step="0.01" required>
            </div>
            <div>
              <label class="form-label small text-muted">Yearly</label>
              <input type="number" class="form-control pricing-input" name="elite_yearly" value="{{ pricing.elite_yearly }}" step="0.01" required>
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary save-pricing">Save Pricing</button>
      </form>
    </div>

    <div class="admin-card fade-up mb-4">
      <h5><i class="bi bi-ticket-perforated text-success me-2"></i>Discount Management</h5>
      <form id="discountForm">
        <div class="discount-form-group">
          <label class="form-label fw-semibold">Discount Settings</label>
          <div class="d-flex align-items-center gap-3">
            <div>
              <label class="form-label small text-muted">Enable Discount</label>
              <input type="checkbox" class="form-check-input" name="discount_enabled" {% if discount.enabled %}checked{% endif %}>
            </div>
            <div>
              <label class="form-label small text-muted">Discount Percentage (%)</label>
              <input type="number" class="form-control discount-input" name="discount_percentage" value="{{ discount.percentage }}" step="0.1" min="0" max="100" {% if not discount.enabled %}disabled{% endif %}>
            </div>
            <div>
              <label class="form-label small text-muted">Valid Until (Optional)</label>
              <input type="date" class="form-control discount-input" name="discount_expiry" value="{{ discount.expiry|default('') }}" {% if not discount.enabled %}disabled{% endif %}>
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary save-discount">Save Discount</button>
      </form>
      <div class="alert alert-info mt-3">
        <small><i class="bi bi-info-circle me-1"></i>Discount applies as a first-month reduction to new subscriptions. Recurring at promo rate if enabled.</small>
      </div>
    </div>

    <div class="admin-card fade-up mb-4">
      <h5><i class="bi bi-person-lines-fill text-warning me-2"></i>Recent Users</h5>
      <div class="table-responsive">
        <table class="table table-admin table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th>Full Name</th>
              <th>Joined</th>
              <th>Trades</th>
              <th>Plan</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in recent_users %}
            <tr>
              <td>{{ user.id }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.full_name }}</td>
              <td>{{ user.joined }}</td>
              <td>{{ user.trades }}</td>
              <td><span class="badge badge-{{ user.plan.lower() }} px-2 py-1">{{ user.plan }}</span></td>
              <td>
                <select id="plan-{{ user.id }}" class="form-select form-select-sm d-inline-block w-auto" style="width: auto;">
                  <option value="starter" {% if user.plan.lower() == 'starter' %}selected{% endif %}>Starter</option>
                  <option value="pro" {% if user.plan.lower() == 'pro' %}selected{% endif %}>Pro</option>
                  <option value="elite" {% if user.plan.lower() == 'elite' %}selected{% endif %}>Elite</option>
                </select>
                <button onclick="updatePlan({{ user.id }})" class="btn btn-sm btn-primary btn-admin-sm ms-1">Update</button>
              </td>
            </tr>
            {% endfor %}
            {% if not recent_users %}
            <tr>
              <td colspan="7" class="text-center text-muted">No users found</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="admin-card fade-up">
      <h5><i class="bi bi-arrow-repeat text-primary me-2"></i>Recent Trades</h5>
      <div class="table-responsive">
        <table class="table table-trades table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>User</th>
              <th>Symbol</th>
              <th>PnL</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for trade in recent_trades %}
            <tr class="{% if trade.pnl >= 0 %}table-success{% else %}table-danger{% endif %}">
              <td>{{ trade.id }}</td>
              <td>{{ trade.user_name }}</td>
              <td>{{ trade.symbol }}</td>
              <td class="{% if trade.pnl >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">{{ trade.pnl }}</td>
              <td>{{ trade.created }}</td>
              <td><button class="btn btn-sm btn-outline-secondary btn-admin-sm">View</button></td>
            </tr>
            {% endfor %}
            {% if not recent_trades %}
            <tr>
              <td colspan="6" class="text-center text-muted">No trades found</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.getElementById('themeToggle').addEventListener('click', () => {
      const html = document.documentElement;
      const icon = document.querySelector('#themeToggle i');
      if (html.getAttribute('data-theme') === 'dark') {
        html.setAttribute('data-theme', 'light');
        icon.classList.replace('bi-sun', 'bi-moon');
      } else {
        html.setAttribute('data-theme', 'dark');
        icon.classList.replace('bi-moon', 'bi-sun');
      }
    });

    function updatePlan(userId) {
      const select = document.getElementById(`plan-${userId}`);
      const plan = select.value;
      fetch(`/admin/update_plan/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `plan=${plan}`
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw new Error(err.detail || 'Failed to update plan'); });
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          alert('Plan updated successfully!');
          location.reload();
        } else {
          alert('Error updating plan: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating plan: ' + (error.message || 'Unknown error'));
      });
    }

    document.getElementById('pricingForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      fetch('/admin/update_pricing', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw new Error(err.detail || 'Failed to update pricing'); });
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          alert('Pricing updated successfully!');
          location.reload();
        } else {
          alert('Error updating pricing: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating pricing: ' + (error.message || 'Unknown error'));
      });
    });

    document.getElementById('discountForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      fetch('/admin/update_discount', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw new Error(err.detail || 'Failed to update discount'); });
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          alert('Discount updated successfully!');
          location.reload();
        } else {
          alert('Error updating discount: ' + (data.message || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error updating discount: ' + (error.message || 'Unknown error'));
      });
    });

    document.querySelector('input[name="discount_enabled"]').addEventListener('change', function() {
      const inputs = document.querySelectorAll('.discount-input');
      inputs.forEach(input => input.disabled = !this.checked);
    });
  </script>
</body>
</html>