{% extends "base.html" %}
{% block title %}Beta Invites - Admin{% endblock %}

{% block extra_styles %}
<style>
  :root {
    --brand-500: #2F6BFF;
    --brand-600: #1F55E0;
    --success: #22C55E;
    --danger: #EF4444;
    --bg: #F8FAFC;
    --surface: #FFFFFF;
    --text: #1E293B;
    --muted: #64748B;
    --border: #E2E8F0;
    --radius: 12px;
    --card-shadow: 0 4px 12px rgba(15,23,42,0.06);
    --card-shadow-strong: 0 8px 24px rgba(15,23,42,0.12);
    --accent: #06B6D4;
  }
  [data-theme="dark"] {
    --bg: #0B0F16;
    --surface: #0F1724;
    --text: #E5E7EB;
    --muted: #94A3B8;
    --border: rgba(148,163,184,0.18);
  }

  html, body { height: 100%; margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
  body { background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }

  .container-main { max-width: 1200px; margin: 0 auto; padding: 22px; }
  .brand { color: var(--brand-500); font-weight: 700; font-size: 1.125rem; }

  .admin-card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--card-shadow); border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; }
  .admin-card h5 { margin-bottom: 15px; color: var(--text); font-weight: 600; }

  .table-admin th { font-weight: 600; color: var(--text); }
  .table-admin td { color: var(--muted); }
  .badge-available { background: rgba(34,197,94,0.1); color: var(--success); }
  .badge-used { background: rgba(239,68,68,0.1); color: var(--danger); }
  .code-cell { font-family: monospace; font-size: 0.9rem; background: rgba(47,107,255,0.05); padding: 4px 8px; border-radius: 4px; word-break: break-all; }
  .owner-cell { font-size: 0.85rem; }
  .fade-up { animation: fadeUp .28s ease both; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--card-shadow-strong);
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
  }
  .toast.show { opacity: 1; transform: translateX(0); }
  .toast.success { border-left: 4px solid var(--success); }
  .toast.error { border-left: 4px solid var(--danger); }
  .toast i { font-size: 1.25rem; }

  @media (max-width: 768px) { .container-main { padding: 14px; } }
</style>
{% endblock %}

{% block content %}
<main class="container-main">
  <div class="position-relative fade-up" style="margin-bottom:18px">
    <div>
      <div style="font-size:1rem;color:var(--muted)">
        <a href="/admin" style="color: var(--muted); text-decoration: none;">Back to Admin</a>
      </div>
      <div style="font-size:1.6rem;font-weight:700">Beta Invite Codes</div>
    </div>
  </div>

  <div class="admin-card fade-up">
    <h5><i class="bi bi-key text-secondary me-2"></i>All Beta Invites ({{ total_invites }})</h5>
    
    <div class="table-responsive">
      <table class="table table-admin table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Code</th>
            <th>Owner</th>
            <th>Used By</th>
            <th>Status</th>
            <th>Created</th>
            <th>Used At</th>
          </tr>
        </thead>
        <tbody>
          {% for invite in beta_invites %}
          <tr>
            <td>{{ invite.id }}</td>
            <td><span class="code-cell">{{ invite.code }}</span></td>
            <td>
              {% if invite.owner_email %}
                <span class="owner-cell">{{ invite.owner_email }} (ID: {{ invite.owner_id }})</span>
              {% else %}
                <span class="text-muted">Pool (Global)</span>
              {% endif %}
            </td>
            <td>
              {% if invite.used_by_email %}
                {{ invite.used_by_email }} (ID: {{ invite.used_by_id }})
              {% else %}
                <span class="text-muted">Unused</span>
              {% endif %}
            </td>
            <td>
              <span class="badge {% if not invite.used_by_id %}badge-available{% else %}badge-used{% endif %}">
                {% if not invite.used_by_id %}Available{% else %}Used{% endif %}
              </span>
            </td>
            <td>{{ invite.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
            <td>{{ invite.used_at.strftime('%Y-%m-%d %H:%M') if invite.used_at else '-' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="text-center text-muted">No beta invites found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <nav aria-label="Beta invites pagination" class="mt-4">
      <ul class="pagination justify-content-center">
        <!-- Previous -->
        {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="?page={{ pagination.prev_num }}&search={{ search or '' }}&used={{ used if used is not none else '' }}&owner_id={{ owner_id or '' }}">Previous</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}

        <!-- Page Numbers -->
        {% for num in pagination.iter_pages() %}
          {% if num %}
            {% if num == pagination.page %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}&search={{ search or '' }}&used={{ used if used is not none else '' }}&owner_id={{ owner_id or '' }}">{{ num }}</a>
              </li>
            {% endif %}
          {% else %}
            <li class="page-item disabled"><span class="page-link">â€¦</span></li>
          {% endif %}
        {% endfor %}

        <!-- Next -->
        {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ pagination.next_num }}&search={{ search or '' }}&used={{ used if used is not none else '' }}&owner_id={{ owner_id or '' }}">Next</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
  // Toast Notification
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type} show`;
    toast.innerHTML = `
      <i class="bi ${type === 'success' ? 'bi-check-circle-fill text-success' : 'bi-exclamation-triangle-fill text-danger'}"></i>
      <div>${message}</div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  // Copy code to clipboard
  document.querySelectorAll('.code-cell').forEach(cell => {
    cell.style.cursor = 'pointer';
    cell.title = 'Click to copy';
    cell.addEventListener('click', () => {
      navigator.clipboard.writeText(cell.textContent).then(() => {
        const original = cell.textContent;
        cell.textContent = 'Copied!';
        setTimeout(() => cell.textContent = original, 1500);
        showToast('Code copied to clipboard');
      }).catch(() => {
        showToast('Failed to copy', 'error');
      });
    });
  });
</script>
{% endblock %}