<!-- templates/dashboard.html -->
{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
  /* Base styles for the search input */
  #signalSearch {
    max-width: 400px;
  }
  
  /* Dark mode: Dark semi-transparent bg, white text, light placeholder */
  [data-theme="dark"] #signalSearch {
    background: rgba(26, 31, 43, 0.9) !important; /* Matches --surface */
    color: var(--text) !important;
    border-color: var(--border) !important;
  }
  
  [data-theme="dark"] #signalSearch::placeholder {
    color: var(--muted) !important;
    opacity: 1 !important;
  }
  
  /* Light mode: Clean white/light bg, dark text, dark placeholder */
  [data-theme="light"] #signalSearch,
  #signalSearch { /* Fallback if no theme set */
    background: rgba(255, 255, 255, 0.9) !important;
    color: #212529 !important; /* Bootstrap's default dark text */
    border-color: rgba(0, 0, 0, 0.15) !important;
  }
  
  [data-theme="light"] #signalSearch::placeholder,
  #signalSearch::placeholder { /* Fallback */
    color: rgba(0, 0, 0, 0.6) !important;
    opacity: 1 !important;
  }
  
  /* Optional: Enhance focus state for both modes */
  #signalSearch:focus {
    box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25) !important;
    border-color: var(--bs-primary) !important;
  }

  /* UPDATED: Subscriptions Widget (Includes Active + Pending) */
  .subscriptions-widget {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 20px;
  }
  .subscriptions-widget h6 { margin-bottom: 12px; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
  .sub-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }
  .sub-item:last-child { border-bottom: none; }
  .sub-item.pending { opacity: 0.7; }
  .sub-item.pending .status-badge { background: var(--warning); color: #000; }
  .sub-item.active .status-badge { background: var(--success); color: white; }
  .status-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* Marketplace Subscribe Modals (Adapted from plans.html) */
  .processing-modal .modal-content { border: none; border-radius: var(--radius); box-shadow: var(--shadow-lg); background: linear-gradient(145deg, var(--surface), rgba(255,255,255,0.8)); backdrop-filter: blur(10px); }
  [data-theme="dark"] .processing-modal .modal-content { background: linear-gradient(145deg, var(--surface), rgba(0,0,0,0.2)); }
  .processing-modal .modal-body { color: var(--text); }
  .processing-spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top: 4px solid var(--brand-500); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .progress-step { display: flex; align-items: center; margin-bottom: 15px; padding: 8px 0; border-left: 3px solid var(--brand-500); padding-left: 12px; }
  .progress-step i { color: var(--brand-500); font-size: 1.2rem; margin-right: 10px; }
  .checkout-modal .modal-content { border: none; border-radius: var(--radius); box-shadow: var(--shadow-lg); background: var(--surface); overflow: hidden; position: relative; max-width: 500px; margin: 1.75rem auto; }
  [data-theme="dark"] .checkout-modal .modal-content { background: var(--surface); }
  .checkout-modal .modal-content::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--brand-500), var(--gold)); }
  .modal-header { border-bottom: none; padding: 2rem 2rem 1rem; text-align: center; position: relative; z-index: 1; }
  .modal-title { color: var(--text); font-weight: 700; font-size: 1.5rem; letter-spacing: -0.02em; margin-bottom: 0.5rem; }
  .modal-subtitle { color: var(--muted); font-size: 0.95rem; margin: 0; }
  .modal-body { color: var(--text); padding: 0 2rem 2rem; }
  .modal-body .text-muted { color: var(--muted); }
  .modal-footer { border-top: 1px solid var(--border); padding: 1.5rem 2rem 2rem; margin-top: auto; }
  .email-highlight { background: linear-gradient(135deg, rgba(47,107,255,0.1), rgba(252,211,77,0.1)); padding: 4px 8px; border-radius: 6px; font-family: 'SF Mono', monospace; color: var(--brand-500); font-weight: 600; }
  [data-theme="dark"] .email-highlight { background: linear-gradient(135deg, rgba(47,107,255,0.2), rgba(252,211,77,0.2)); }
  .step-icon { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--brand-500), var(--brand-600)); color: white; display: inline-flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 1rem; font-weight: 700; box-shadow: 0 2px 8px rgba(47,107,255,0.2); flex-shrink: 0; }
  .premium-badge { background: linear-gradient(135deg, var(--gold), #FBBF24); color: #B45309; padding: 4px 8px; border-radius: 16px; font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 8px rgba(252,211,77,0.2); }
  .order-summary { background: var(--bg); border: 1px solid var(--border); border-radius: calc(var(--radius) - 4px); padding: 1.25rem; margin: 1.5rem 0; position: relative; overflow: hidden; }
  .order-summary::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, var(--success), var(--gold)); }
  .order-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; font-size: 0.9rem; }
  .order-item:last-child { font-weight: 700; font-size: 1.125rem; border-top: 1px solid var(--border); padding-top: 0.75rem; color: var(--brand-500); margin-top: 0.5rem; }
  .discount { color: var(--success); font-weight: 600; }
  .security-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(34,197,94,0.1); color: var(--success); padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; margin-bottom: 1rem; justify-content: center; }
  [data-theme="dark"] .security-badge { background: rgba(34,197,94,0.2); }
  .btn-premium { 
    background: linear-gradient(135deg, #3b82f6, #1d4ed8); /* ← FIXED: Hardcoded blue gradient for consistent visibility in both themes */
    border: none; 
    border-radius: calc(var(--radius) - 4px); 
    padding: 12px 24px; 
    font-weight: 600; 
    font-size: 0.95rem; 
    box-shadow: 0 4px 12px rgba(47,107,255,0.2); 
    transition: all 0.3s ease; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 8px; 
    color: white !important; /* ← KEY FIX: Forces white text for visibility in dark/light */
    text-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Subtle shadow for extra pop in dark mode */
  }
  .btn-premium:hover { 
    transform: translateY(-1px); 
    box-shadow: 0 6px 16px rgba(47,107,255,0.3); 
    color: white !important; /* Ensures hover stays visible */
  }
  .btn-secondary-premium { 
    background: transparent; 
    border: 1px solid var(--border); 
    color: var(--text) !important; /* ← FIX: Explicit text color inherits theme (dark: light text, light: dark text) */
    border-radius: calc(var(--radius) - 4px); 
    padding: 12px 24px; 
    font-weight: 500; 
    transition: all 0.3s ease; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 8px; 
  }
  .btn-secondary-premium:hover { 
    background: var(--brand-500); 
    color: white !important; /* White on hover bg for contrast */
    border-color: var(--brand-500); 
  }
  .step-card { display: flex; align-items: flex-start; gap: 12px; padding: 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: calc(var(--radius) - 4px); margin-bottom: 1rem; }
  .step-text { flex: 1; }
  .step-title { margin: 0 0 0.25rem; font-weight: 600; font-size: 0.95rem; color: var(--text); }
  .step-desc { 
    margin: 0; 
    color: var(--muted); 
    font-size: 0.85rem; 
  }
  /* FIX: Ensure step-desc visibility in light mode (fallback to darker color if vars fail) */
  [data-theme="light"] .step-desc,
  .step-desc { /* Fallback if no theme set */
    color: #6c757d !important; /* Bootstrap muted fallback - visible dark gray on white */
  }
  [data-theme="dark"] .step-desc {
    color: var(--muted) !important; /* Light muted for dark bg */
  }
  /* Also ensure step-title is visible in light mode */
  [data-theme="light"] .step-title,
  .step-title { /* Fallback */
    color: #212529 !important; /* Dark text on light bg */
  }
  .vip-alert { background: linear-gradient(135deg, rgba(252,211,77,0.08), rgba(245,158,11,0.08)); border: 1px solid rgba(252,211,77,0.2); border-radius: calc(var(--radius) - 4px); padding: 1rem; margin: 1rem 0; display: flex; align-items: center; gap: 8px; }
  .email-alert { background: linear-gradient(135deg, rgba(6,182,212,0.08), rgba(47,107,255,0.08)); border: 1px solid rgba(6,182,212,0.2); border-radius: calc(var(--radius) - 4px); padding: 1rem; margin-bottom: 1rem; }
  .email-details { display: flex; flex-direction: column; gap: 0.25rem; font-size: 0.85rem; }
  .email-details strong { color: var(--text); }
  .email-details .text-muted { color: var(--muted); }

  /* FIXED: Modal footer stacking – more breathing room, especially mobile */
  .modal-footer { 
    border-top: 1px solid var(--border); 
    padding: 1.5rem 2rem 2rem; /* Increased bottom padding */
    margin-top: auto; 
    gap: 1rem; /* ← ADD: Explicit gap for better vertical spacing */
  }
  .modal-footer .d-grid {
    gap: 1rem !important; /* ← ENFORCE: Bigger gap between stacked buttons */
  }

  /* Mobile tweak: Slightly wider modal on small screens to avoid squeeze */
  @media (max-width: 576px) {
    .checkout-modal .modal-dialog {
      margin: 1rem;
      max-width: 95vw;
    }
    .modal-footer {
      padding: 1rem 1.5rem 1.5rem; /* Compact but balanced on mobile */
    }
    .btn-premium, .btn-secondary-premium {
      padding: 14px 20px; /* Taller buttons for fat-finger friendly */
      font-size: 1rem;
    }
  }

  /* Theme-aware overrides for Bootstrap classes in modals */
  .checkout-modal .text-dark,
  .processing-modal .text-dark {
    color: var(--text) !important;
  }
  .checkout-modal .text-muted,
  .processing-modal .text-muted {
    color: var(--muted) !important;
  }
  .checkout-modal .text-primary,
  .processing-modal .text-primary {
    color: var(--brand-500) !important;
  }
  .checkout-modal .text-success,
  .processing-modal .text-success {
    color: var(--success) !important;
  }

  /* IMPROVED: Trade Points Widget - More visual with icons, better spacing, and a subtle gradient accent */
  .trade-points-widget {
    background: linear-gradient(145deg, var(--surface), rgba(var(--brand-500-rgb), 0.05));
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
  }
  .trade-points-widget::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--brand-500), var(--gold));
  }
  .trade-points-widget h6 { 
    margin-bottom: 16px; 
    border-bottom: none; 
    color: var(--text);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .trade-points-widget h6::before {
    content: '';
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, var(--brand-500), var(--gold));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: white;
    content: '⭐';
  }
  .points-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .points-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: calc(var(--radius) - 4px);
    transition: all 0.2s ease;
  }
  .points-item:hover {
    border-color: var(--brand-500);
    box-shadow: 0 2px 8px rgba(var(--brand-500-rgb), 0.1);
  }
  .points-item .label {
    font-size: 0.8rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .points-item .label i {
    font-size: 0.9rem;
  }
  .points-item .value {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--brand-500);
    margin: 0;
  }
  .tier-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 700;
    background: linear-gradient(135deg, #3b82f6, #1d4ed8); /* ← FIXED: Hardcoded blue gradient for consistent visibility in both themes (matches .btn-premium) */
    color: white !important; /* ← KEY FIX: Forces white text for visibility in dark/light */
    box-shadow: 0 2px 4px rgba(47,107,255,0.2); /* ← UPDATED: Hardcoded blue shadow for consistency */
    text-shadow: 0 1px 1px rgba(0,0,0,0.1);
    display: inline-block;
    min-width: fit-content;
  }
  .points-info {
    background: rgba(var(--brand-500-rgb), 0.05);
    border: 1px solid rgba(var(--brand-500-rgb), 0.1);
    border-radius: calc(var(--radius) - 4px);
    padding: 12px;
    font-size: 0.85rem;
    color: var(--muted);
  }

  /* IMPROVED: Invites Section - Card-based layout with better visuals, icons, and consistent theming */
  .referrals-section {
    margin-bottom: 40px;
  }
  .referrals-section .session-title {
    font-weight: 700;
    color: var(--text);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .referral-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 24px;
    position: relative;
    overflow: hidden;
  }
  .referral-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--brand-500), var(--gold));
  }
  .referral-card .fw-bold {
    font-size: 1.25rem;
    color: var(--text);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .referral-card .fw-bold i {
    color: var(--brand-500);
  }
  .referral-card .text-muted {
    font-size: 0.95rem;
    margin-bottom: 20px;
    color: var(--muted);
  }
  .referral-code {
    font-family: 'SF Mono', monospace;
    font-weight: 700;
    font-size: 1.5rem;
    color: var(--brand-500);
    background: linear-gradient(135deg, rgba(var(--brand-500-rgb), 0.1), rgba(var(--gold-rgb), 0.1));
    padding: 16px;
    border-radius: 12px;
    text-align: center;
    border: 2px dashed var(--brand-500);
    margin-bottom: 20px;
    letter-spacing: 0.05em;
  }
  .beta-codes-list {
    max-height: 250px;
    overflow-y: auto;
    margin-bottom: 20px;
  }
  .beta-code-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: calc(var(--radius) - 4px);
    margin-bottom: 8px;
    transition: all 0.2s ease;
  }
  .beta-code-item:hover,
  .beta-code-item:last-child {
    border-color: var(--brand-500);
    box-shadow: 0 2px 8px rgba(var(--brand-500-rgb), 0.1);
  }
  .beta-code-item:last-child {
    margin-bottom: 0;
  }
  .beta-code {
    font-family: 'SF Mono', monospace;
    font-weight: 700;
    color: var(--brand-500);
    background: rgba(var(--brand-500-rgb), 0.1);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 1rem;
  }
  .beta-actions {
    display: flex;
    gap: 6px;
  }
  .beta-btn {
    padding: 6px 10px;
    font-size: 0.8rem;
    border-radius: 6px;
    border: none;
    background: linear-gradient(135deg, var(--brand-500), var(--brand-600));
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .beta-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(var(--brand-500-rgb), 0.2);
  }
  .no-invites-msg {
    text-align: center;
    padding: 32px 16px;
    color: var(--muted);
    font-style: italic;
    background: var(--bg);
    border: 1px dashed var(--border);
    border-radius: calc(var(--radius) - 4px);
  }
  .no-invites-msg i {
    font-size: 2rem;
    color: var(--brand-500);
    display: block;
    margin-bottom: 12px;
  }
  .referral-stats {
    display: flex;
    justify-content: center;
    margin: 20px 0;
  }
  .stat-item {
    text-align: center;
    padding: 12px;
    background: linear-gradient(135deg, rgba(var(--brand-500-rgb), 0.1), rgba(var(--gold-rgb), 0.1));
    border-radius: 12px;
    flex: 1;
    max-width: 120px;
  }
  .stat-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--brand-500);
    margin-bottom: 4px;
  }
  .stat-label {
    font-size: 0.8rem;
    color: var(--muted);
    font-weight: 500;
  }
  .share-buttons {
    display: flex;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .share-btn {
    padding: 10px 16px;
    border-radius: 24px;
    border: none;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .share-btn-copy {
    background: linear-gradient(135deg, var(--brand-500), var(--brand-600));
    color: white;
  }
  .share-btn-copy:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(var(--brand-500-rgb), 0.2);
  }
  .share-btn-twitter {
    background: linear-gradient(135deg, #1DA1F2, #0D8BD9);
    color: white;
  }
  .share-btn-twitter:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(29, 161, 242, 0.3);
  }

  /* Mobile tweaks for improved sections */
  @media (max-width: 768px) {
    .points-grid {
      grid-template-columns: 1fr;
    }
    .share-buttons {
      flex-direction: column;
      width: 100%;
    }
    .share-btn {
      justify-content: center;
    }
    .beta-actions {
      flex-direction: column;
    }
    .beta-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
<main class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Hero Header -->
      <div class="card-radius hero-header fade-up">
        <div class="row align-items-center text-center text-md-start">
          <div class="col-md-4 mb-4 mb-md-0">
            <div class="d-flex align-items-center justify-content-center justify-md-start gap-3">
              <div class="user-avatar rounded-circle d-flex justify-content-center align-items-center text-white fw-bold" style="width:64px; height:64px; background:var(--gradient);" id="userInitialsHero">{{ initials }}</div>
              <div>
                <div class="greeting">{{ greeting }}</div>
                <div class="text-muted small">today's edge: <span class="edge">{% if todays_edge > 0 %}+{% endif %}{{ "%.1f"|format(todays_edge) }}%</span></div>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-4 mb-md-0">
            <div class="pnl-big" id="pnlBig" style="color: {% if pnl_summary.daily.value < 0 %}var(--danger){% else %}var(--success){% endif %};">${{ "%.0f"|format(pnl_summary.daily.value) if pnl_summary.daily.value else 0 }}</div>
            <div class="pnl-subtitle" id="pnlSubtitle" title="P&L based on trade dates (not when logged)">({{ "%.1f"|format(pnl_summary.daily.percent) }}% today)</div>
            <div style="height: 40px; width: 100%;">
              <canvas id="pnlSpark" class="w-100 h-100" style="display: block;"></canvas>
            </div>
            <div class="btn-group view-toggles mt-3" role="group">
              <button type="button" class="btn active" data-view="daily">Daily</button>
              <button type="button" class="btn" data-view="weekly">Weekly</button>
              <button type="button" class="btn" data-view="monthly">Monthly</button>
            </div>
          </div>
          <div class="col-md-4 d-flex justify-content-end">
            <button class="btn btn-outline-primary" onclick="scrollToMarketplace()">Browse Signals</button>
          </div>
        </div>
      </div>

  <!-- UPDATED: Subscriptions Widget (Includes Active + Pending) -->
  <div class="subscriptions-widget">
    <h6>Active Subscriptions</h6>
    {% if active_subs %}
      {% for sub in active_subs %}
      <div class="sub-item active">
        {% if sub.trader_id %}
          <span>{{ sub.trader_name }} ({{ sub.win_rate }}% Win)</span>
        {% else %}
          <span>Platform: {{ sub.plan_type | title }} Plan</span>
        {% endif %}
        <span class="status-badge">Active</span>
        <small class="text-muted">Renews {{ sub.next_bill }}</small>
      </div>
      {% endfor %}
    {% else %}
      <p class="text-muted small mb-0">No active subscriptions yet.</p>
    {% endif %}

{% if pending_subs %}
<h6 class="mt-3">Pending Payments</h6>
  {% for sub in pending_subs %}
  <div class="sub-item pending">
    {% if sub.trader_id %}
      <span>{{ sub.trader_name }} ({{ sub.win_rate }}% Win)</span>
    {% else %}
      <span>Platform: {{ sub.plan_type | title }} Plan</span>
    {% endif %}
    <span class="status-badge">Pending</span>
    <small class="text-muted">Payment in progress</small>
  </div>
  {% endfor %}
{% endif %}

<a href="/subscriptions" class="btn btn-sm btn-outline-primary mt-3">Manage Subscriptions</a>  </div>

  <!-- IMPROVED: Trade Points Widget -->
  <div class="trade-points-widget">
    <h6>Trade Points</h6>
    <div class="points-grid">
      <div class="points-item">
        <div class="label"><i class="bi bi-crown"></i> Tier</div>
        <div class="value"><span class="tier-badge">{{ referral_tier | title }}</span></div>
      </div>
      <div class="points-item">
        <div class="label"><i class="bi bi-wallet2"></i> Current Balance</div>
        <div class="value">{{ points_balance }} TP</div>
      </div>
      <div class="points-item">
        <div class="label"><i class="bi bi-graph-up-arrow"></i> Total Earned</div>
        <div class="value">{{ total_tp_earned }} TP</div>
      </div>
    </div>
    <div class="points-info">
      <small><i class="bi bi-lightbulb me-1"></i>Use TP to unlock trade uploads, AI insights, and chat sessions. Earn more by referring friends!</small>
    </div>
  </div>

  <!-- IMPROVED: Integrated Invites Section -->
  <section class="referrals-section fade-up">
    <h5 class="session-title"><i class="bi bi-share-fill"></i> Your Invites</h5>
    <div class="card-radius">
      <div class="referral-card">
        {% if beta_active %}
        <div class="fw-bold mb-2"><i class="bi bi-lock-fill"></i> Beta Invites</div>
        <p class="text-muted mb-4">Share your beta codes. Friends signing up with your code will earn you Trade Points (TP) for uploads and insights.</p>
        <div class="beta-codes-list">
          {% if available_beta_codes %}
            {% for code in available_beta_codes %}
            <div class="beta-code-item">
              <span class="beta-code">{{ code }}</span>
              <div class="beta-actions">
                <button class="beta-btn" onclick="copyBetaCode('{{ code }}')" title="Copy Invite Link">
                  <i class="bi bi-copy"></i> Copy
                </button>
                <button class="beta-btn" onclick="shareBetaOnX('{{ code }}')" title="Share on X">
                  <i class="bi bi-twitter-x"></i> X
                </button>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="no-invites-msg">
              <i class="bi bi-inbox"></i>
              <p>No available invites at the moment.</p>
              <small>Contact support for more opportunities.</small>
            </div>
          {% endif %}
        </div>
        {% else %}
        <div class="fw-bold mb-2"><i class="bi bi-people"></i> Referral Code</div>
        <p class="text-muted mb-4">Share your unique code. Friends signing up with your code will earn you Trade Points (TP) for uploads and insights.</p>
        <div class="referral-code" id="referralCode">{{ referral_code }}</div>
        {% endif %}
        <div class="referral-stats">
          <div class="stat-item">
            <div class="stat-number">{{ used_beta_count if beta_active else referrals_count }}</div>
            <div class="stat-label">Referred</div>
          </div>
        </div>
        {% if not beta_active %}
        <div class="share-buttons">
          <button class="share-btn share-btn-copy" onclick="copyReferralCode()">
            <i class="bi bi-copy"></i> Copy Link
          </button>
          <button class="share-btn share-btn-twitter" onclick="shareOnTwitter()">
            <i class="bi bi-twitter-x"></i> Share on X
          </button>
        </div>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Marketplace Section -->
  <section class="marketplace-section fade-up">
    <div class="text-center mb-5">
      <h2 class="fw-bold mb-3">Master Signals Await</h2>
      <p class="text-muted">Discover proven strategies from top traders</p>
    </div>
    <div class="mb-5">
      <input type="text" class="form-control rounded-pill mx-auto d-block" id="signalSearch" placeholder="Search by name or strategy..." style="max-width: 400px; background: rgba(0, 0, 0, 0.5);">
    </div>
    <div class="recommendations mb-5">
      <h5 class="mb-4">Recommendations</h5>
      <div class="row" id="recommendations">
        {% for rec in recommendations %}
        <div class="col-md-6 mb-4">
          <div class="card-radius rec-card p-4" data-name="{{ rec.name }}" data-strategy="{{ rec.strategy }}">
            <div class="d-flex align-items-center gap-3 mb-3">
              <div class="user-avatar rounded-circle d-flex justify-content-center align-items-center text-white fw-bold" style="width:40px; height:40px; background:var(--gradient);">{{ rec.initials }}</div>
              <div>
                <div class="fw-bold">{{ rec.name }}</div>
                <span class="badge text-white rounded-pill px-2 py-1" style="background:var(--gradient);">{{ rec.win_rate }}% Win</span>
              </div>
            </div>
            <div class="text-muted small mb-3">{{ rec.trades }} trades | ${{ "%.0f"|format(rec.pnl) }}</div>
            <p class="small mb-3">"{{ rec.strategy }}"</p>
            {% if rec.status %}
              {% if rec.status == 'active' %}
              <button class="btn btn-success rounded-pill w-100" disabled data-subbed="true">Subscribed</button>
              {% elif rec.status == 'pending' %}
              <button class="btn btn-warning rounded-pill w-100 pending-btn" data-subbed="true">Pending Payment</button>
              {% endif %}
            {% else %}
            <button class="btn btn-outline-primary rounded-pill w-100 subscribe-btn" data-trader="{{ rec.id }}" data-price="{{ rec.monthly_price }}" data-name="{{ rec.name }}" data-subbed="false">Sub ${{ "%.2f"|format(rec.monthly_price) }}/mo</button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    <div class="top-traders">
      <h5 class="mb-4">Top Traders</h5>
      <div class="row g-3" id="topTraders">
        {% for trader in traders %}
        <div class="col-lg-4 col-md-6">
          <div class="card-radius trader-card mb-3 p-3" data-name="{{ trader.name }}" data-strategy="{{ trader.strategy }}" onclick="showTeaserModal({{ trader.id }})">
            <div class="d-flex align-items-start gap-3 mb-3">
              <div class="user-avatar rounded-circle d-flex justify-content-center align-items-center text-white fw-bold" style="width:48px; height:48px; background:var(--gradient); flex-shrink:0;">{{ trader.initials }}</div>
              <div class="flex-grow-1">
                <div class="fw-bold mb-1">{{ trader.name }}</div>
                <div class="text-muted small">{{ trader.strategy }}</div>
              </div>
              <span class="badge text-white rounded-pill px-2 py-1" style="background:var(--success);">{{ trader.win_rate }}% Win</span>
            </div>
            <div class="text-muted small mb-3">Trades: {{ trader.trades }} | Losses: {{ trader.losses }} | P&L: ${{ "%.0f"|format(trader.pnl) }}</div>
            <div style="height: 30px; width: 100%; margin-bottom: 1rem;">
              <canvas class="trader-spark lazy-spark w-100 h-100" data-values="{{ trader.trend | tojson }}" style="display: block;"></canvas>
            </div>
            <div class="journal-tease text-muted small" style="display:none;">{{ trader.journal_tease }}</div>
            {% if trader.status %}
              {% if trader.status == 'active' %}
              <button class="btn btn-success rounded-pill w-100" disabled data-subbed="true">Subscribed</button>
              {% elif trader.status == 'pending' %}
              <button class="btn btn-warning rounded-pill w-100 pending-btn" data-subbed="true">Pending Payment</button>
              {% endif %}
            {% else %}
            <button class="btn btn-primary rounded-pill w-100 subscribe-btn" data-trader="{{ trader.id }}" data-price="{{ trader.monthly_price }}" data-name="{{ trader.name }}" data-subbed="false">Subscribe for ${{ "%.2f"|format(trader.monthly_price) }}/mo</button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="text-center mt-4">
        <button class="btn btn-outline-secondary rounded-pill" onclick="loadMoreTraders()">Load More</button>
      </div>
    </div>
  </section>

  <!-- Marketplace Processing Modal (Adapted from plans.html) -->
  <div class="modal fade processing-modal" id="marketplaceProcessingModal" tabindex="-1" aria-labelledby="marketplaceProcessingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center p-5">
          <div class="processing-spinner"></div>
          <h2 class="mb-3 fw-bold" id="marketplaceProcessingModalLabel">Securing Your Subscription</h2>
          <p class="text-muted mb-4">Preparing access to <span id="marketplaceProcessingTraderName" class="fw-semibold text-primary"></span>...</p>
          <div class="progress-step">
            <i class="bi bi-check-lg text-success"></i>
            <span class="fw-medium">Verifying your selection</span>
          </div>
          <div class="progress-step">
            <i class="bi bi-shield-check text-primary"></i>
            <span class="fw-medium">Generating secure invoice</span>
          </div>
          <div class="progress-step">
            <i class="bi bi-unlock-fill text-success"></i>
            <span class="fw-medium">Ready to activate on payment</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Marketplace Confirmation Modal (Adapted from plans.html) -->
  <div class="modal fade checkout-modal" id="marketplaceConfirmationModal" tabindex="-1" aria-labelledby="marketplaceConfirmationModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <i class="bi bi-gem text-primary fs-2 mb-3 d-block" style="filter: drop-shadow(0 2px 4px rgba(47,107,255,0.1));"></i>
          <h1 class="modal-title" id="marketplaceConfirmationModalLabel">Payment Ready</h1>
          <p class="modal-subtitle">Complete payment to unlock <span id="marketplaceSelectedTraderName" class="fw-semibold text-primary"></span>'s signals – instant access.</p>
        </div>
        <div class="modal-body">
          <div class="security-badge w-100">
            <i class="bi bi-shield-lock-fill"></i>
            <span>Crypto Payment • Secure • Instant Unlock</span>
          </div>
          <div class="order-summary">
            <h6 class="fw-bold mb-3 text-uppercase text-muted small">Order Summary</h6>
            <div class="order-item">
              <span class="fw-medium"><span id="marketplaceSelectedTraderNameSum"></span> Subscription</span>
              <span class="text-primary fw-semibold" id="marketplaceBillingCycle">Monthly</span>
            </div>
            <div class="order-item" id="marketplaceDiscountRow" style="display: none;">
              <span class="text-muted">Launch Discount</span>
              <span id="marketplaceDiscountText" class="discount fw-bold"></span>
            </div>
            <div class="order-item">
              <span class="fw-bold text-dark">Total</span>
              <span id="marketplaceTotalAmount" class="text-success fw-bold"></span>
            </div>
          </div>
          <h6 class="fw-bold mb-2 text-uppercase text-muted small">Next Steps</h6>
          <div class="step-card">
            <div class="step-icon"><i class="bi bi-1-circle"></i></div>
            <div class="step-text">
              <p class="step-title">Click Pay Now</p>
              <p class="step-desc">Opens secure invoice – expires in ~1 hour.</p>
            </div>
          </div>
          <div class="step-card">
            <div class="step-icon"><i class="bi bi-2-circle"></i></div>
            <div class="step-text">
              <p class="step-title">Select & Pay Crypto</p>
              <p class="step-desc">BTC, ETH, USDT + 100+ options. No KYC.</p>
            </div>
          </div>
          <div class="step-card">
            <div class="step-icon"><i class="bi bi-3-circle"></i></div>
            <div class="step-text">
              <p class="step-title">Signals Unlocked</p>
              <p class="step-desc">Access activates immediately on confirmation.</p>
            </div>
          </div>
          <div class="vip-alert" id="marketplaceVipAlert" style="display: none;">
            <i class="bi bi-star-fill text-warning"></i>
            <span class="premium-badge">VIP</span>
            <span class="fw-semibold flex-grow-1" id="marketplaceVipDiscountText"></span>
          </div>
        </div>
        <div class="modal-footer">
          <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-premium" id="marketplaceOpenEmailBtn">
              <i class="bi bi-credit-card"></i>
              Pay Now
            </button>
            <button class="btn btn-secondary-premium" id="marketplaceDashboardBtn">
              <i class="bi bi-house-door"></i>
              Back to Dashboard
            </button>
          </div>
          <small class="text-muted text-center mt-3 d-block w-100">
            Powered by NowPayments. Cancel anytime. 
            <a href="mailto:contact@itradex.xyz" class="text-primary fw-semibold">Support</a>.
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Teaser Modal for Trader Samples -->
  <div class="modal fade" id="teaserModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="teaserTitle">Sample Trades</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="teaserContent">
          <p>Loading samples...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="subscribeFromTeaser()">Subscribe Now</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Session Zones -->
  <section class="sessions-section fade-up">
    <div class="map-overlay"></div>
    <h5 class="session-title"><i class="bi bi-globe2"></i> Your Session Zones</h5>
    <div class="session-carousel" id="sessionCarousel">
      {% for session in sessions %}
      <div class="card-radius session-card" onclick="toggleExpand(this)">
        <div class="session-icon"><i class="bi {{ session.icon }}"></i></div>
        <div class="fw-bold" style="font-size:1.2rem;">{{ session.name }}</div>
        <div class="session-stats">Trades: {{ session.trades }} | Win Rate: {{ session.winRate }}% | Avg P&L: {{ session.avgPnL }}</div>
        <div style="height: 30px; width: 100%; margin-bottom: 1rem;">
          <canvas class="session-spark lazy-spark w-100 h-100" data-values="{{ session.trend | tojson }}" style="display: block;"></canvas>
        </div>
        <div class="expand-details">
          Last trade: <strong>{{ session.lastTrade }}</strong>
          <div class="ai-tip"><i class="bi bi-lightbulb me-2"></i>{{ session.tip }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
    <div id="emptyState" class="empty-state" style="display: {% if sessions %}none{% else %}block{% endif %};">
      <i class="bi bi-inbox empty-icon"></i>
      <p>Start logging to unlock sessions</p>
      <button class="btn btn-outline-primary" onclick="location.href='/upload'">Upload something</button>
    </div>
  </section>

  <!-- Quick Actions -->
  <div class="quick-actions fade-up">
    <div class="quick-action-btn" onclick="location.href='/upload'">
      <div class="quick-icon"><i class="bi bi-cloud-upload"></i></div>
      <div>Log Trade</div>
    </div>
    <div class="quick-action-btn" onclick="location.href='/journal'">
      <div class="quick-icon"><i class="bi bi-journal-text"></i></div>
      <div>View Journal</div>
    </div>
    <div class="quick-action-btn" onclick="location.href='/insights'">
      <div class="quick-icon"><i class="bi bi-lightbulb"></i></div>
      <div>Generate Insights</div>
    </div>
    <div class="quick-action-btn" onclick="document.getElementById('signalSearch')?.focus()">
      <div class="quick-icon"><i class="bi bi-search"></i></div>
      <div>Browse Signals</div>
    </div>
  </div>
</div>  </div>
</main>
{% endblock %}

{% block mobile_fab %}
  <button id="mobileFab" class="btn d-flex align-items-center justify-content-center" onclick="location.href='/upload'">
    <i class="bi bi-plus-lg fs-3"></i>
  </button>
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let pnlChart;
  let currentView = 'daily';
  const pnlHistory = {{ pnl_history | tojson }};
  const pnlData = {{ pnl_summary | tojson }};  // ← FIXED: was `pnl`
  const marketplaceDiscount = {{ marketplace_discount | tojson }};
  const betaActive = {{ beta_active | tojson }};

  // PNL Sparkline improved - no animation
  function initPnlSpark(view = 'daily') {
    const canvas = document.getElementById('pnlSpark');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const history = pnlHistory[view] || [0,0,0,0,0];
    const isUp = history[history.length - 1] >= history[0];
    const borderColor = isUp ? 'var(--success)' : 'var(--danger)';
    const bgColor = isUp ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)';
    if (pnlChart) pnlChart.destroy();
    pnlChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: history.map((_, i) => i),
        datasets: [{
          data: history,
          borderColor: borderColor,
          backgroundColor: bgColor,
          tension: 0.4,
          fill: true,
          pointRadius: 3,
          pointBackgroundColor: borderColor,
          pointBorderColor: 'white',
          pointBorderWidth: 2,
          borderWidth: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { display: false }, y: { display: false } },
        plugins: { legend: { display: false }, tooltip: { enabled: true } },
        animation: false,
        elements: { line: { borderCapStyle: 'round', borderJoinStyle: 'round' } }
      }
    });
  }
  initPnlSpark();

  // View toggles
  const pnlBigEl = document.getElementById('pnlBig');
  const pnlSubtitleEl = document.querySelector('.pnl-subtitle');
  const periodText = {
    daily: 'today',
    weekly: 'this week',
    monthly: 'this month'
  };
  document.querySelectorAll('.view-toggles .btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.view-toggles .btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentView = btn.dataset.view;
      const data = pnlData[currentView];
      const value = data.value;
      const percent = data.percent;
      pnlBigEl.textContent = `$${Math.round(value).toLocaleString()}`;
      pnlBigEl.style.color = value < 0 ? 'var(--danger)' : 'var(--success)';
      pnlSubtitleEl.textContent = `(${percent.toFixed(1)}% ${periodText[currentView]})`;
      initPnlSpark(currentView);
    });
  });

  // Generic spark init for lazy charts - no animation
  function initLazySpark(canvas) {
    let values = JSON.parse(canvas.dataset.values || '[]');
    if (!values.length) values = [0, 0, 0, 0, 0];
    const ctx = canvas.getContext('2d');
    const isUp = values[values.length - 1] >= values[0];
    const borderColor = isUp ? 'var(--success)' : 'var(--danger)';
    const bgColor = isUp ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)';
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: values.map((_, i) => i),
        datasets: [{
          data: values,
          borderColor: borderColor,
          backgroundColor: bgColor,
          tension: 0.4,
          fill: true,
          pointRadius: 0,
          borderWidth: 3,
          borderJoinStyle: 'round'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { display: false }, y: { display: false } },
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        animation: false,
        elements: { line: { borderCapStyle: 'round', borderJoinStyle: 'round' } }
      }
    });
  }

  // Unified lazy observer for all sparklines except PNL
  const lazyObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        setTimeout(() => initLazySpark(entry.target), 50);
        lazyObserver.unobserve(entry.target);
      }
    });
  }, { threshold: 0.1 });
  document.querySelectorAll('.lazy-spark').forEach(canvas => lazyObserver.observe(canvas));

  // Toggle expand
  function toggleExpand(card) {
    const details = card.querySelector('.expand-details');
    details.style.display = details.style.display === 'block' ? 'none' : 'block';
  }

  // Marketplace search
  let searchTimeout;
  const searchEl = document.getElementById('signalSearch');
  if (searchEl) {
    searchEl.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.rec-card, .trader-card').forEach(card => {
          const name = card.dataset.name?.toLowerCase() || '';
          const strategy = card.dataset.strategy?.toLowerCase() || '';
          card.style.display = (name.includes(query) || strategy.includes(query)) ? 'block' : 'none';
        });
      }, 200);
    });
  }

  // UPDATED: Marketplace Subscribe Handler (Direct Invoice Flow)
  let currentTraderId = null;
  let currentTraderName = null;
  let currentTraderPrice = null;
  const marketplaceProcessingModal = new bootstrap.Modal(document.getElementById('marketplaceProcessingModal'), {backdrop: 'static', keyboard: false});
  const marketplaceConfirmationModal = new bootstrap.Modal(document.getElementById('marketplaceConfirmationModal'), {backdrop: 'static', keyboard: false});
  const marketplaceSelectedTraderNameSpan = document.getElementById('marketplaceSelectedTraderName');
  const marketplaceSelectedTraderNameSumSpan = document.getElementById('marketplaceSelectedTraderNameSum');
  const marketplaceProcessingTraderNameSpan = document.getElementById('marketplaceProcessingTraderName');
  const marketplaceBillingCycleSpan = document.getElementById('marketplaceBillingCycle');
  const marketplaceTotalAmountSpan = document.getElementById('marketplaceTotalAmount');
  const marketplaceOpenEmailBtn = document.getElementById('marketplaceOpenEmailBtn');
  const marketplaceDashboardBtn = document.getElementById('marketplaceDashboardBtn');
  const marketplaceDiscountRow = document.getElementById('marketplaceDiscountRow');
  const marketplaceDiscountText = document.getElementById('marketplaceDiscountText');
  const marketplaceVipAlert = document.getElementById('marketplaceVipAlert');
  const marketplaceVipDiscountText = document.getElementById('marketplaceVipDiscountText');

  function safeSetText(element, value) {
    if (element) {
      element.textContent = value;
    } else {
      console.error(`Element not found for text update: ${value}`);
    }
  }

  async function handleMarketplaceCheckout(traderId, traderName, price) {
    const btn = event.target;  // Assuming called from click event
    if (btn.dataset.subbed === 'true') {
      showToast('Already subscribed or pending!');
      return;  // ← KEY: Prevent if already set
    }
    const originalText = btn.innerHTML;
    btn.disabled = true;
    safeSetText(marketplaceProcessingTraderNameSpan, traderName);
    marketplaceProcessingModal.show();

    let discountedTotal = price;
    const discountPerc = marketplaceDiscount || 0;
    if (discountPerc > 0) {
      const discount = price * (discountPerc / 100);
      discountedTotal = price - discount;
      if (marketplaceDiscountRow && marketplaceDiscountText) {
        safeSetText(marketplaceDiscountText, `-${discountPerc}% First Month`);
        marketplaceDiscountRow.style.display = 'flex';
        marketplaceVipAlert.style.display = 'flex';
        if (marketplaceVipDiscountText) {
          safeSetText(marketplaceVipDiscountText, `${discountPerc}% off first month included.`);
        }
      }
    }

    try {
      const res = await fetch('/payments/marketplace/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ 
          trader_id: traderId, 
          interval: 'monthly', 
          amount: discountedTotal  // ← FIXED: Send pre-calculated discounted amount
        })
      });
      if (!res.ok) {
        return res.json().then(err => { throw new Error(err.detail || 'Failed to create subscription'); });
      }
      const data = await res.json();
      console.log('Marketplace Checkout data:', data);
      marketplaceProcessingModal.hide();
      marketplaceConfirmationModal.show();
      safeSetText(marketplaceSelectedTraderNameSpan, traderName);
      safeSetText(marketplaceSelectedTraderNameSumSpan, traderName);
      safeSetText(marketplaceBillingCycleSpan, 'Monthly');
      
      safeSetText(marketplaceTotalAmountSpan, `$${Math.max(discountedTotal, 0.01).toFixed(2)}`);
      
      const payUrl = data.invoice_url;
      if (!payUrl) {
        throw new Error('No payment link generated');
      }
      marketplaceOpenEmailBtn.onclick = () => { window.open(payUrl, '_blank'); };
      marketplaceDashboardBtn.onclick = () => {
        marketplaceConfirmationModal.hide();
        location.reload();  // Reload to update active subs
      };

      // Update button to subscribed (pending)
      btn.dataset.subbed = 'true';
      btn.innerHTML = 'Pending Payment';
      btn.classList.replace('btn-primary', 'btn-warning');
      btn.classList.replace('btn-outline-primary', 'btn-warning');
      btn.classList.add('pending-btn');

    } catch (err) {
      console.error('Marketplace Checkout error:', err);
      marketplaceProcessingModal.hide();
      alert('Subscription setup failed: ' + err.message + '\n\nPlease try again or contact support.');
    } finally {
      setTimeout(() => {
        btn.disabled = false;
        if (!btn.dataset.subbed) {
          btn.innerHTML = originalText;
        }
      }, 2000);
    }
  }

  document.querySelectorAll('.subscribe-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (btn.dataset.subbed === 'true') {
        showToast('Already handling subscription!');
        return;  // ← KEY: Prevent redundant clicks
      }
      currentTraderId = parseInt(btn.dataset.trader);
      currentTraderName = btn.dataset.name;
      currentTraderPrice = parseFloat(btn.dataset.price);
      handleMarketplaceCheckout(currentTraderId, currentTraderName, currentTraderPrice);
    });
  });

  // NEW: Pending Payment Button Handler - Redirect to Subscriptions
  document.querySelectorAll('.pending-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      e.preventDefault();
      showToast('Redirecting to complete payment...');
      window.location.href = '/subscriptions';
    });
  });

  // Teaser modal
  async function showTeaserModal(traderId) {
    const modal = new bootstrap.Modal(document.getElementById('teaserModal'));
    document.getElementById('teaserTitle').textContent = `Sample Trades from Trader ${traderId}`;
    const contentEl = document.getElementById('teaserContent');
    contentEl.innerHTML = '<div class="spinner-border" role="status"></div> Loading samples...';
    try {
      const res = await fetch(`/journal/trades?source=trader&trader_id=${traderId}&page_size=2`);
      const data = await res.json();
      if (data.trades.length > 0) {
        contentEl.innerHTML = data.trades.map(t => `
          <div class="trade-sample mb-3 p-3 border rounded">
            <strong>${t.symbol}</strong> | P&L: ${t.pnl >= 0 ? '+' : ''}$${t.pnl?.toFixed(2)}
            <small>${t.notes || 'No notes'}</small>
          </div>
        `).join('');
      } else {
        contentEl.innerHTML = '<p>No samples available yet.</p>';
      }
    } catch (err) {
      contentEl.innerHTML = '<p>Unable to load samples.</p>';
    }
    modal.show();
  }

  function subscribeFromTeaser() {
    const btn = document.querySelector(`[data-trader="${currentTraderId}"]`);
    if (btn && btn.dataset.subbed !== 'true') {
      btn.click();
    } else {
      showToast('Already subscribed or pending!');
    }
    bootstrap.Modal.getInstance(document.getElementById('teaserModal')).hide();
  }

  // Journal tease on hover
  document.querySelectorAll('.trader-card').forEach(card => {
    const tease = card.querySelector('.journal-tease');
    card.addEventListener('mouseenter', () => {
      if (tease) tease.style.display = 'block';
    });
    card.addEventListener('mouseleave', () => {
      if (tease) tease.style.display = 'none';
    });
  });

  function loadMoreTraders() {
    showToast('More traders loaded!');
  }

  function scrollToMarketplace() {
    document.querySelector('.marketplace-section').scrollIntoView({ behavior: 'smooth' });
  }

  // Mobile fab pulse
  const mobileFab = document.getElementById('mobileFab');
  if (mobileFab) {
    mobileFab.style.animation = 'pulse 2s infinite';
  }
  const style = document.createElement('style');
  style.innerHTML = `@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(47,107,255,0.4); } 70% { box-shadow: 0 0 0 10px rgba(47,107,255,0); } 100% { box-shadow: 0 0 0 0 rgba(47,107,255,0); } }`;
  document.head.appendChild(style);

  {% if not beta_active %}
  // Referral functions
  function copyReferralCode() {
    const code = document.getElementById('referralCode').textContent;
    const referralUrl = `${window.location.origin}/?ref=${code}`;
    navigator.clipboard.writeText(referralUrl).then(() => {
      showToast('Referral link copied!');
    }).catch(() => {
      const textArea = document.createElement('textarea');
      textArea.value = referralUrl;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      showToast('Referral link copied!');
    });
  }

  function shareOnTwitter() {
    const code = document.getElementById('referralCode').textContent;
    const text = `Join me on iTrade Journal! Use my referral code ${code} to get started. Earn TP together! ${window.location.origin}/?ref=${code}`;
    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
  }
  {% endif %}

  // Beta Invite Functions (always available)
  function copyBetaCode(code) {
    const betaUrl = `${window.location.origin}/?beta=${code}`;
    navigator.clipboard.writeText(betaUrl).then(() => {
      showToast('Beta invite link copied!');
    }).catch(() => {
      const textArea = document.createElement('textarea');
      textArea.value = betaUrl;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      showToast('Beta invite link copied!');
    });
  }

  function shareBetaOnX(code) {
    const text = `Exclusive beta access to iTrade Journal! Use my code ${code} to join the beta. ${window.location.origin}/?beta=${code}`;
    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
  }

  function showToast(msg) {
    const toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--success);color:white;padding:10px;border-radius:4px;z-index:9999;';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function showErrorToast(msg) {
    const toast = document.createElement('div');
    toast.textContent = msg;
    toast.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--danger);color:white;padding:10px;border-radius:4px;z-index:9999;';
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
</script>
{% endblock %}